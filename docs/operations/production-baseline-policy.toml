# Production baseline policy (desired state)

# This file is the canonical, versioned definition of what the production VPS
# should look like for HealthArchive. It is intentionally small and focused on
# invariants that matter for security, correctness, and operability.
#
# Paired tooling:
# - Observed snapshot generator: `scripts/baseline_snapshot.py`
# - Drift checker: `scripts/check_baseline_drift.py`
#
# The drift checker validates this policy against the real VPS configuration
# (without printing or persisting secrets).

version = 2

# The operator account expected to run deploy scripts and ops checks.
operator_user = "haadmin"

# The shared ops group used for sensitive-but-operator-writable directories.
ops_group = "healtharchive"

[urls]
frontend_primary = "https://healtharchive.ca"
frontend_aliases = ["https://www.healtharchive.ca"]
api_base = "https://api.healtharchive.ca"

[files]
backend_env_file = "/etc/healtharchive/backend.env"
caddyfile = "/etc/caddy/Caddyfile"

[backend_env_required]
HEALTHARCHIVE_ENV = "production"
HEALTHARCHIVE_ARCHIVE_ROOT = "/srv/healtharchive/jobs"
HEALTHARCHIVE_PUBLIC_SITE_URL = "https://healtharchive.ca"
HEALTHARCHIVE_REPLAY_BASE_URL = "https://replay.healtharchive.ca"
HEALTHARCHIVE_REPLAY_PREVIEW_DIR = "/srv/healtharchive/replay/previews"
HEALTHARCHIVE_USAGE_METRICS_ENABLED = "1"
HEALTHARCHIVE_USAGE_METRICS_WINDOW_DAYS = "30"
HEALTHARCHIVE_EXPORTS_ENABLED = "1"

[backend_env_csv_set_equals]
# CORS allowlist is intentionally strict in this project. Keep it narrow and
# keep it exact (no extra origins in prod).
HEALTHARCHIVE_CORS_ORIGINS = [
  "https://healtharchive.ca",
  "https://www.healtharchive.ca",
  "https://healtharchive.vercel.app",
]

[cors]
# When running drift checks in --mode live, validate that the API actually
# returns the expected CORS headers for allowed origins (and does not for a
# known-disallowed origin).
probe_path = "/api/health"
disallowed_origins = ["https://example.com"]

[security]
# Admin endpoints must not be public in production.
admin_token_required = true

# HSTS should be enabled at the reverse proxy for the API domain.
hsts_required = true
hsts_header_min_max_age_seconds = 31536000

[filesystem]
[[filesystem.paths]]
path = "/etc/healtharchive"
owner = "root"
group = "healtharchive"
mode = "0750"
required = true

[[filesystem.paths]]
path = "/etc/healtharchive/backend.env"
owner = "root"
group = "healtharchive"
mode = "0640"
required = true

[[filesystem.paths]]
path = "/srv/healtharchive/backups"
owner = "root"
group = "healtharchive"
mode = "2770"
required = true

[[filesystem.paths]]
path = "/srv/healtharchive/ops"
owner = "root"
group = "healtharchive"
mode = "2770"
required = true

[[filesystem.paths]]
path = "/srv/healtharchive/ops/baseline"
owner = "root"
group = "healtharchive"
mode = "2770"
required = true

[[filesystem.paths]]
path = "/srv/healtharchive/ops/restore-tests"
owner = "root"
group = "healtharchive"
mode = "2770"
required = true

[[filesystem.paths]]
path = "/srv/healtharchive/ops/adoption"
owner = "root"
group = "healtharchive"
mode = "2770"
required = true

[[filesystem.paths]]
path = "/srv/healtharchive/ops/search-eval"
owner = "root"
group = "healtharchive"
mode = "2770"
required = true

# Archive root can be owned by the operator user; enforce "exists + writable"
# rather than a strict owner/group/mode.
[[filesystem.paths]]
path = "/srv/healtharchive/jobs"
required = true
must_be_writable = true

[systemd]
[[systemd.units]]
name = "healtharchive-api.service"
required = true
must_be_enabled = true

[[systemd.units]]
name = "healtharchive-worker.service"
required = true
must_be_enabled = true
