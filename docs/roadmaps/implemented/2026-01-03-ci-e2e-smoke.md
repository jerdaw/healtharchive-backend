# CI end-to-end smoke coverage (implementation plan)

Status: **implemented** (2026-01-03)

## Goal

Add a **fast, local** end-to-end smoke check to CI that exercises the
public‑critical surfaces:

- Frontend: `GET /archive`, `GET /snapshot/{id}`
- Backend: `GET /api/search`, `GET /api/sources`, `GET /api/snapshot/{id}`

The intent is to catch “app starts but user-critical paths fail” regressions
early (miswired env, breaking API contract changes, runtime errors, etc.).

## Scope

- Reuse the existing `healtharchive-backend/scripts/verify_public_surface.py`
  verifier by running it against locally started backend + frontend.
- Seed a tiny SQLite database + tiny WARC so that:
  - `/api/sources` is non-empty,
  - `/api/search` returns at least one snapshot,
  - `/api/snapshots/raw/{id}` can serve real HTML.
- Add GitHub Actions jobs to run the smoke check in:
  - `healtharchive-backend` CI (checks backend changes against latest frontend `main`),
  - `healtharchive-frontend` CI (checks frontend changes against latest backend `main`).
- Update canonical docs to describe the smoke check and local reproduction steps.

## Non-goals

- Full browser automation (Playwright/Cypress).
- Replay (pywb) service validation; the CI smoke should not depend on replay being present.
- Performance benchmarking or search quality evaluation.

## Implementation steps

1. Add a backend script to seed an e2e dataset:
   - Create schema (SQLite).
   - Insert seed sources.
   - Write a tiny gzipped WARC with one HTML record.
   - Insert a `Snapshot` pointing at that WARC record.
2. Add a backend script to run the e2e smoke:
   - Start backend via `uvicorn` on a fixed local port.
   - Start frontend via `next build` + `next start` on a fixed local port.
   - Run `verify_public_surface.py` with `--api-base` and `--frontend-base`
     pointing at the local servers, and `--skip-replay`.
   - Ensure clean shutdown on success/failure.
3. Wire the CI workflows (backend + frontend) to run the smoke script as a
   separate job alongside the existing unit/lint checks.
4. Update docs:
   - Add a short section to `docs/operations/monitoring-and-ci-checklist.md`
     describing what the smoke covers and how to run it locally.
   - Remove this item from `docs/roadmaps/roadmap.md`.

## Acceptance criteria

- Running the smoke locally succeeds:
  - `healtharchive-backend/scripts/ci-e2e-smoke.sh`
- Backend CI includes an “e2e smoke” job that is green on `main`.
- Frontend CI includes an “e2e smoke” job that is green on `main`.
- Canonical docs mention the smoke check and how to reproduce failures locally.
