<!--
HealthArchive custom replay banner for pywb (non-framed replay).

Deploy by copying this file to:
  /srv/healtharchive/replay/templates/custom_banner.html

Then restart the replay service:
  sudo systemctl restart healtharchive-replay.service

Note: When replay is embedded inside HealthArchive (iframe), this template:
- collapses to a minimal UI (Compare + Hide), and
- sends lightweight postMessage events so the wrapper UI can track the current
  archived URL for edition switching.

Implementation note:
- pywb rewrites absolute `href="https://..."` links inside replayed pages.
  To keep "Back to HealthArchive" and related links working (including
  right-click / middle-click open-in-new-tab), this banner generates a `blob:`
  URL that immediately redirects the browser to the real HealthArchive URL.
-->

	<style id="ha-replay-banner-css">
	  #ha-replay-banner {
	    position: sticky;
	    top: 0;
	    z-index: 2147483647;
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    background-color: rgba(255, 255, 255, 0.9);
    background-color: color-mix(in srgb, rgba(255, 255, 255, 0.9) 82%, transparent);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
      sans-serif;
    font-size: 0.85rem;
    line-height: 1.25;
    -webkit-font-smoothing: antialiased;
    backdrop-filter: blur(10px) saturate(1.1);
    box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
  }

  #ha-replay-banner::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: -23px;
    height: 27px;
    pointer-events: none;
    background: linear-gradient(
      to bottom,
      rgba(15, 23, 42, 0.02) 0%,
      rgba(15, 23, 42, 0) 100%
    );
  }

  #ha-replay-banner * {
    box-sizing: border-box;
  }

  #ha-replay-banner .ha-replay-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.8rem 1.25rem;
  }

  #ha-replay-banner .ha-replay-left,
  #ha-replay-banner .ha-replay-right {
    display: flex;
    align-items: center;
    gap: 0.45rem;
    flex-shrink: 0;
  }

  #ha-replay-banner .ha-replay-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.18rem 0.6rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.1);
    border: 1px solid rgba(37, 99, 235, 0.25);
    color: #2563eb;
    font-weight: 650;
    white-space: nowrap;
  }

  #ha-replay-banner .ha-replay-center {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.2rem;
    overflow: hidden;
  }

  #ha-replay-banner .ha-replay-meta {
    color: rgba(15, 23, 42, 0.7);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }

  #ha-replay-banner .ha-replay-disclaimer {
    color: rgba(15, 23, 42, 0.55);
    overflow: hidden;
    max-width: 100%;
    white-space: normal;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  #ha-replay-banner a,
  #ha-replay-banner button {
    appearance: none;
    border: 1px solid transparent;
    background: transparent;
    color: rgba(15, 23, 42, 0.72);
    border-radius: 999px;
    padding: 0.3rem 0.85rem;
    font: inherit;
    font-weight: 550;
    cursor: pointer;
    line-height: 1;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  #ha-replay-banner a,
  #ha-replay-banner button {
    transition: background 120ms ease, border-color 120ms ease, transform 120ms ease;
  }

  #ha-replay-banner a:hover,
  #ha-replay-banner button:hover {
    color: rgba(15, 23, 42, 0.95);
    transform: translateY(-1px);
    background: rgba(148, 163, 184, 0.16);
    text-decoration: none;
  }

  #ha-replay-banner .ha-replay-brand {
    appearance: none;
    border: none;
    background: transparent;
    padding: 0.3rem 0.85rem;
    margin: 0;
    font: inherit;
    font-weight: 600;
    color: rgba(15, 23, 42, 0.95);
    cursor: pointer;
  }

  #ha-replay-banner .ha-replay-brand:hover {
    background: rgba(148, 163, 184, 0.16);
    text-decoration: none;
  }

  #ha-replay-banner .ha-replay-action-link {
    appearance: none;
    border: 1px solid transparent;
    background-color: #2563eb;
    color: #ffffff;
    border-radius: 999px;
    padding: 0.3rem 0.85rem;
    font: inherit;
    font-weight: 550;
    cursor: pointer;
    box-shadow: 0 10px 24px rgba(37, 99, 235, 0.35);
  }

  #ha-replay-banner .ha-replay-action-link:hover {
    background-color: #1d4ed8;
    color: #ffffff;
    text-decoration: none;
  }

  #ha-replay-banner .ha-replay-link {
    padding: 0.3rem 0.85rem;
    font-weight: 550;
    color: rgba(15, 23, 42, 0.72);
  }

  #ha-replay-banner .ha-replay-link:hover {
    color: rgba(15, 23, 42, 0.95);
    background: rgba(148, 163, 184, 0.16);
  }

	  #ha-replay-banner .ha-replay-divider {
	    width: 1px;
	    height: 20px;
	    background: rgba(148, 163, 184, 0.35);
	  }

	  #ha-replay-banner.ha-replay-embedded .ha-replay-center,
	  #ha-replay-banner.ha-replay-embedded .ha-replay-pill,
	  #ha-replay-banner.ha-replay-embedded [data-ha-action="browse"],
	  #ha-replay-banner.ha-replay-embedded [data-ha-action="details"],
	  #ha-replay-banner.ha-replay-embedded [data-ha-action="raw"],
	  #ha-replay-banner.ha-replay-embedded [data-ha-action="json"],
	  #ha-replay-banner.ha-replay-embedded .ha-replay-divider {
	    display: none !important;
	  }

	  #ha-replay-banner.ha-replay-embedded .ha-replay-inner {
	    padding: 0.4rem 0.6rem;
	    justify-content: flex-end;
	  }

	  #ha-replay-banner.ha-replay-embedded .ha-replay-right {
	    gap: 0.35rem;
	  }

	  @media (max-width: 640px) {
	    #ha-replay-banner .ha-replay-inner {
	      padding-inline: 0.9rem;
	    }
  }

  @media (max-width: 780px) {
    #ha-replay-banner .ha-replay-center {
      display: none;
    }
    #ha-replay-banner .ha-replay-divider {
      display: none;
    }
  }
</style>

	<script id="ha-replay-banner-js">
	  (function () {
	    var MESSAGE_TYPE = "haReplayNavigation";
	    var HEIGHT_MESSAGE_TYPE = "haReplayHeight";
	    var SNAPSHOT_STORAGE_KEY = "haReplaySnapshotId";
	    var COMPARE_LATEST_STORAGE_KEY = "haReplayLatestSnapshotId";
	    var refreshCompareLink = null;
	    var heightTimer = null;

	    function isEmbedded() {
	      try {
	        return window !== window.top;
      } catch (e) {
        // If we can't access window.top, assume we're embedded.
        return true;
      }
    }

	    function sendReplayNavigation() {
	      if (!isEmbedded()) return;

      var wb = window.wbinfo || {};
      var payload = {
        type: MESSAGE_TYPE,
        coll: wb.coll || null,
        timestamp: wb.timestamp || null,
        url: wb.url || null,
        topUrl: wb.top_url || null,
      };

      var key = String(payload.coll) + "|" + String(payload.timestamp) + "|" + String(payload.url);
      if (sendReplayNavigation._lastKey === key) return;
      sendReplayNavigation._lastKey = key;

      try {
        window.parent.postMessage(payload, "*");
      } catch (e) {
        // Ignore cross-origin messaging failures.
      }
	    }

	    function computeDocumentHeight() {
	      try {
	        var doc = document.documentElement;
	        var body = document.body;
	        var heights = [
	          body ? body.scrollHeight : 0,
	          body ? body.offsetHeight : 0,
	          doc ? doc.clientHeight : 0,
	          doc ? doc.scrollHeight : 0,
	          doc ? doc.offsetHeight : 0,
	        ];
	        var max = 0;
	        for (var i = 0; i < heights.length; i++) {
	          var v = heights[i];
	          if (typeof v === "number" && isFinite(v)) max = Math.max(max, v);
	        }
	        return max > 0 ? max : null;
	      } catch (e) {
	        return null;
	      }
	    }

	    function sendReplayHeight() {
	      if (!isEmbedded()) return;

	      var height = computeDocumentHeight();
	      if (!height) return;
	      height = Math.max(0, Math.floor(height));
	      if (height < 120) return;

	      if (sendReplayHeight._lastHeight === height) return;
	      sendReplayHeight._lastHeight = height;

	      try {
	        window.parent.postMessage({ type: HEIGHT_MESSAGE_TYPE, height: height }, "*");
	      } catch (e) {
	        // Ignore cross-origin messaging failures.
	      }
	    }

	    function scheduleReplayHeight() {
	      if (!isEmbedded()) return;
	      if (heightTimer) return;
	      heightTimer = setTimeout(function () {
	        heightTimer = null;
	        sendReplayHeight();
	      }, 120);
	    }

	    function onNavigationChanged() {
	      sendReplayNavigation();
	      scheduleReplayHeight();
	      try {
	        if (typeof refreshCompareLink === "function") refreshCompareLink();
	      } catch (e) {}
	    }

	    onNavigationChanged();

	    window.addEventListener("pageshow", onNavigationChanged);
	    window.addEventListener("hashchange", onNavigationChanged);
	    window.addEventListener("popstate", onNavigationChanged);
	    window.addEventListener("load", scheduleReplayHeight);
	    window.addEventListener("resize", scheduleReplayHeight);

	    try {
	      var origPushState = history.pushState;
	      var origReplaceState = history.replaceState;

	      history.pushState = function () {
	        var result = origPushState.apply(this, arguments);
	        setTimeout(onNavigationChanged, 0);
	        return result;
	      };

	      history.replaceState = function () {
	        var result = origReplaceState.apply(this, arguments);
	        setTimeout(onNavigationChanged, 0);
	        return result;
	      };
	    } catch (e) {
	      // Ignore history patching failures.
	    }

	    // Allow the banner UI to be disabled for screenshot generation or debugging.
	    // We use a fragment flag (not a query param) because replay URLs already
	    // embed the original URL and its query string.
	    try {
      if (/ha_nobanner/i.test(window.location.hash || "")) return;
    } catch (e) {
      // Ignore location access failures.
    }

    var STORAGE_KEY = "haReplayBannerDismissed";
    try {
      if (localStorage.getItem(STORAGE_KEY) === "1") return;
    } catch (e) {
      // Ignore storage failures.
    }

	    function loadSnapshotId() {
	      var raw = "";
	      try {
	        raw = window.location.hash || "";
      } catch (e) {
        raw = "";
      }
      var hash = raw.replace(/^#/, "");
      var snapshotId = null;
      try {
        var params = new URLSearchParams(hash);
        snapshotId = params.get("ha_snapshot") || params.get("haSnapshot");
      } catch (e) {
        snapshotId = null;
      }

      if (snapshotId) {
        try {
          sessionStorage.setItem(SNAPSHOT_STORAGE_KEY, String(snapshotId));
        } catch (e) {}
        return String(snapshotId);
      }

      try {
        var stored = sessionStorage.getItem(SNAPSHOT_STORAGE_KEY);
        if (stored) return stored;
      } catch (e) {}
	      return null;
	    }

	    function parseJobIdFromColl(value) {
	      if (!value || typeof value !== "string") return null;
	      var match = /^job-(\d+)$/.exec(value.trim());
	      if (!match) return null;
	      var parsed = Number(match[1]);
	      return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
	    }

	    function getWbInfo() {
	      var wb = window.wbinfo || {};
	      return {
	        coll: wb.coll || null,
	        timestamp: wb.timestamp || null,
	        url: wb.url || null,
	        topUrl: wb.top_url || null,
	      };
	    }

	    function getApiBaseCandidates(hostname) {
	      // Prefer api.<apex>, but also try the public site origin (some deployments proxy /api there).
	      // Include window.location.origin as a last-ditch candidate for localhost/IP debugging.
	      var scheme = "https://";
	      try {
	        scheme = window.location.protocol === "http:" ? "http://" : "https://";
	      } catch (e) {}

	      var host = String(hostname || "");
	      var isLocal = host === "localhost" || /^\d+\.\d+\.\d+\.\d+$/.test(host);
	      if (isLocal) {
	        var origin = null;
	        try {
	          origin = window.location.origin;
	        } catch (e) {
	          origin = null;
	        }
	        return [
	          "https://api.healtharchive.ca",
	          "https://www.healtharchive.ca",
	          origin,
	        ].filter(Boolean);
	      }

	      var parts = host.split(".").filter(Boolean);
	      var apex = parts.length >= 2 ? parts.slice(-2).join(".") : host;
	      var apiBase = scheme + "api." + apex;
	      var siteBase = scheme + "www." + apex;
	      var apexBase = scheme + apex;
	      return [apiBase, siteBase, apexBase];
	    }

	    function getSiteBase(hostname) {
	      var host = String(hostname || "");
	      if (host.indexOf("replay.") === 0) {
	        return "https://" + "www." + host.slice("replay.".length);
	      }
	      var parts = host.split(".").filter(Boolean);
	      if (parts.length >= 3 && parts[0] === "replay") {
	        parts[0] = "www";
	        return "https://" + parts.join(".");
	      }
	      if (host) return "https://" + host;
	      return "https://" + "www." + "healtharchive.ca";
	    }

	    function formatTimestamp(ts) {
	      if (!ts || typeof ts !== "string" || ts.length < 8) return null;
	      var year = Number(ts.slice(0, 4));
      var month = Number(ts.slice(4, 6));
      var day = Number(ts.slice(6, 8));
      if (!year || !month || !day) return null;
      var d = new Date(Date.UTC(year, month - 1, day));
      if (isNaN(d.getTime())) return null;
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    function buildMeta() {
      var wb = window.wbinfo || {};
      var parts = [];
      if (wb.coll) parts.push("Backup: " + wb.coll);
      var capture = formatTimestamp(wb.timestamp);
      if (capture) parts.push("Captured: " + capture);
      return parts.join(" \u00b7 ");
    }

	    function inject() {
	      if (!document.body) return;

      var banner = document.getElementById("ha-replay-banner");
      if (banner) return;

	      var embedded = false;
	      try {
	        embedded = isEmbedded();
	      } catch (e) {
	        embedded = true;
	      }

	      var snapshotId = loadSnapshotId();

	      banner = document.createElement("div");
	      banner.id = "ha-replay-banner";
	      banner.setAttribute("role", "region");
	      banner.setAttribute("aria-label", "HealthArchive replay notice");
	      if (embedded) {
	        banner.className = "ha-replay-embedded";
	      }

	      banner.innerHTML =
	        '<div class="ha-replay-inner">' +
	        '  <div class="ha-replay-left">' +
	        '    <a class="ha-replay-action-link" data-ha-action="browse" href="#" aria-label="Back to HealthArchive.ca">\u2190 HealthArchive.ca</a>' +
	        '    <span class="ha-replay-pill" aria-label="Archived replay notice">Archived replay</span>' +
	        "  </div>" +
	        '  <div class="ha-replay-center">' +
	        '    <div class="ha-replay-meta" id="ha-replay-meta"></div>' +
	        '    <div class="ha-replay-disclaimer">Independent archive \u00b7 Not an official government website \u00b7 Content may be outdated</div>' +
	        "  </div>" +
	        '  <div class="ha-replay-right" id="ha-replay-actions">' +
	        '    <a class="ha-replay-action-link" data-ha-action="compare" href="#" aria-label="Compare this archived page to the live page">Compare</a>' +
	        (snapshotId
	          ? '    <a class="ha-replay-link" data-ha-action="details" href="#">Snapshot details</a>' +
	            '    <a class="ha-replay-link" data-ha-action="raw" href="#">Raw HTML</a>' +
	            '    <a class="ha-replay-link" data-ha-action="json" href="#">Metadata JSON</a>' +
	            '    <span class="ha-replay-divider" aria-hidden="true"></span>'
	          : "") +
	        '    <button type="button" id="ha-replay-hide" class="ha-replay-link" aria-label="Hide this banner">Hide</button>' +
	        "  </div>" +
	        "</div>";

      document.body.insertBefore(banner, document.body.firstChild);

      var metaEl = document.getElementById("ha-replay-meta");
      if (metaEl) {
        var meta = buildMeta();
        metaEl.textContent = meta || "";
      }

      var hideBtn = document.getElementById("ha-replay-hide");
      if (hideBtn) {
        hideBtn.addEventListener("click", function () {
          try {
            localStorage.setItem(STORAGE_KEY, "1");
          } catch (e) {}
          var el = document.getElementById("ha-replay-banner");
          if (el && el.parentNode) el.parentNode.removeChild(el);
        });
      }

	      // Avoid pywb rewriting our "escape hatch" navigation by:
	      //  - not embedding HealthArchive URLs directly in HTML attributes, and
	      //  - using buttons with explicit JS navigation.
	      try {
	        var haBase = getSiteBase(window.location.hostname);
	        var apiCandidates = getApiBaseCandidates(window.location.hostname);
	        var apiBase = apiCandidates[0];
	        var routes = {
	          browse: snapshotId ? haBase + "/snapshot/" + snapshotId : haBase + "/",
	        };

	        if (snapshotId) {
	          routes.details = haBase + "/snapshot/" + snapshotId;
	          routes.raw = apiBase + "/api/snapshots/raw/" + snapshotId;
	          routes.json = apiBase + "/api/snapshot/" + snapshotId;
	        }

	        function safeJson(url, timeoutMs) {
	          return new Promise(function (resolve, reject) {
	            var timer = null;
	            try {
	              timer = setTimeout(function () {
	                reject(new Error("timeout"));
	              }, timeoutMs || 3500);
	            } catch (e) {}

	            fetch(url, {
	              method: "GET",
	              cache: "no-store",
	              credentials: "omit",
	              headers: { Accept: "application/json" },
	            })
	              .then(function (res) {
	                if (!res.ok) throw new Error("status " + res.status);
	                return res.json();
	              })
	              .then(function (data) {
	                resolve(data);
	              })
	              .catch(reject)
	              .finally(function () {
	                if (timer) clearTimeout(timer);
	              });
	          });
	        }

	        function isHtmlMimeType(value) {
	          if (!value || typeof value !== "string") return false;
	          var normalized = value.split(";")[0].trim().toLowerCase();
	          return normalized === "text/html" || normalized === "application/xhtml+xml";
	        }

	        function formatIsoDate(value) {
	          if (!value || typeof value !== "string") return null;
	          try {
	            var d = new Date(value);
	            if (isNaN(d.getTime())) return null;
	            return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
	          } catch (e) {
	            return null;
	          }
	        }

	        function compactUrl(value) {
	          if (!value || typeof value !== "string") return null;
	          var raw = value.trim();
	          if (!raw) return null;
	          try {
	            var u = new URL(raw);
	            var host = u.hostname || "";
	            var path = (u.pathname || "") + (u.search || "");
	            var out = host + path;
	            if (out.length > 1 && out[out.length - 1] === "/") out = out.slice(0, -1);
	            return out || raw;
	          } catch (e) {
	            return raw.replace(/^https?:\/\//i, "");
	          }
	        }

	        function buildSnapshotSummary(snapshotDetail) {
	          try {
	            var parts = [];
	            if (snapshotDetail && snapshotDetail.title) parts.push(String(snapshotDetail.title));
	            if (snapshotDetail && snapshotDetail.sourceName) parts.push(String(snapshotDetail.sourceName));
	            var wb = getWbInfo();
	            var capture =
	              formatTimestamp(wb.timestamp) ||
	              (snapshotDetail ? formatIsoDate(snapshotDetail.captureTimestamp) : null) ||
	              (snapshotDetail ? formatIsoDate(snapshotDetail.captureDate) : null);
	            if (capture) parts.push(capture);
	            if (snapshotDetail && snapshotDetail.language) parts.push(String(snapshotDetail.language));
	            var urlValue = snapshotDetail && snapshotDetail.originalUrl ? compactUrl(snapshotDetail.originalUrl) : null;
	            if (urlValue) parts.push(urlValue);
	            return parts.filter(Boolean).join(" \u00b7 ");
	          } catch (e) {
	            return null;
	          }
	        }

	        function setCompareRoute(latestSnapshotId) {
	          if (!latestSnapshotId) return;
	          routes.compare = haBase + "/compare-live?to=" + latestSnapshotId + "&run=1";
	          try {
	            sessionStorage.setItem(COMPARE_LATEST_STORAGE_KEY, String(latestSnapshotId));
	          } catch (e) {}
	        }

	        function loadCachedLatestSnapshotId() {
	          try {
	            var stored = sessionStorage.getItem(COMPARE_LATEST_STORAGE_KEY);
	            if (stored) return stored;
	          } catch (e) {}
	          return null;
	        }

	        function buildResolveUrl(base, jobId, originalUrl, timestamp14) {
	          var query = "jobId=" + encodeURIComponent(String(jobId)) + "&url=" + encodeURIComponent(originalUrl);
	          if (timestamp14) query += "&timestamp=" + encodeURIComponent(String(timestamp14));
	          return base + "/api/replay/resolve?" + query;
	        }

	        function buildLatestUrl(base, snapshotIdValue) {
	          return base + "/api/snapshots/" + encodeURIComponent(String(snapshotIdValue)) + "/latest";
	        }

	        function resolveSnapshotAndLatest() {
	          var wb = getWbInfo();
	          var jobId = parseJobIdFromColl(wb.coll);
	          var originalUrl = wb.url;
	          var timestamp14 = typeof wb.timestamp === "string" && /^\d{14}$/.test(wb.timestamp) ? wb.timestamp : null;

	          if (!jobId || !originalUrl) {
	            var cached = loadCachedLatestSnapshotId();
	            if (cached) setCompareRoute(cached);
	            return Promise.resolve();
	          }

	          var bases = apiCandidates.slice();
	          function tryResolveAt(index) {
	            if (index >= bases.length) return Promise.resolve();
	            var base = bases[index];
	            var resolveUrl = buildResolveUrl(base, jobId, originalUrl, timestamp14);
	            return safeJson(resolveUrl, 3500)
	              .then(function (resolved) {
	                if (!resolved || !resolved.snapshotId) return;
	                if (resolved.mimeType != null && !isHtmlMimeType(resolved.mimeType)) return;
	                snapshotId = String(resolved.snapshotId);
	                routes.browse = haBase + "/snapshot/" + snapshotId;
	                routes.details = haBase + "/snapshot/" + snapshotId;
	                routes.raw = base + "/api/snapshots/raw/" + snapshotId;
	                routes.json = base + "/api/snapshot/" + snapshotId;
	                return safeJson(buildLatestUrl(base, snapshotId), 3500).then(function (latest) {
	                  if (latest && latest.found && latest.snapshotId) {
	                    setCompareRoute(String(latest.snapshotId));
	                  } else {
	                    setCompareRoute(snapshotId);
	                  }
	                });
	              })
	              .catch(function () {
	                return tryResolveAt(index + 1);
	              });
	          }

	          return tryResolveAt(0);
	        }

	        var snapshotSummaryCache = {};
	        var snapshotSummaryPendingId = null;

	        function updateSnapshotSummary() {
	          try {
	            if (embedded) return;
	            var metaEl = document.getElementById("ha-replay-meta");
	            if (!metaEl) return;

	            if (!snapshotId || !routes.json) {
	              metaEl.textContent = buildMeta() || "";
	              return;
	            }

	            var cached = snapshotSummaryCache[snapshotId];
	            if (cached) {
	              metaEl.textContent = cached;
	              metaEl.setAttribute("title", cached);
	              return;
	            }

	            if (snapshotSummaryPendingId === snapshotId) return;
	            var nextSnapshotId = snapshotId;
	            var nextJsonUrl = routes.json;
	            snapshotSummaryPendingId = nextSnapshotId;

	            safeJson(nextJsonUrl, 3500)
	              .then(function (detail) {
	                if (!detail) return;
	                if (!nextSnapshotId) return;
	                var summary = buildSnapshotSummary(detail);
	                if (!summary) return;
	                snapshotSummaryCache[nextSnapshotId] = summary;
	                if (snapshotId !== nextSnapshotId) return;
	                metaEl.textContent = summary;
	                metaEl.setAttribute("title", summary);
	              })
	              .catch(function () {})
	              .finally(function () {
	                if (snapshotSummaryPendingId === nextSnapshotId) snapshotSummaryPendingId = null;
	              });
	          } catch (e) {}
	        }

	        function makeRedirectBlobUrl(dest) {
	          try {
            function escapeHtmlAttr(value) {
              return String(value)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;");
            }

            function escapeHtmlText(value) {
              return String(value)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
            }

            var html =
              "<!doctype html><meta charset=utf-8>" +
              "<meta name=referrer content=no-referrer>" +
              "<title>Redirecting...</title>" +
              '<meta http-equiv="refresh" content="0;url=' +
              escapeHtmlAttr(dest) +
              '">' +
              "<p>Redirecting to <a href=" +
              JSON.stringify(dest) +
              ">" +
              escapeHtmlText(dest) +
              "</a>...</p>";
            return URL.createObjectURL(new Blob([html], { type: "text/html" }));
          } catch (e) {
            return dest;
          }
        }

	        var blobCache = {};

	        function setActionHref(el, dest) {
	          if (!el) return;
	          try {
	            if (!dest) {
	              el.removeAttribute("data-ha-dest");
	              if (el.tagName && el.tagName.toLowerCase() === "a") {
	                el.setAttribute("href", "#");
	                el.setAttribute("aria-disabled", "true");
	              }
	              return;
	            }

	            var blobUrl = blobCache[dest] || (blobCache[dest] = makeRedirectBlobUrl(dest));
	            if (el.tagName && el.tagName.toLowerCase() === "a") {
	              el.setAttribute("href", blobUrl);
	              el.setAttribute("data-ha-dest", dest);
	              el.removeAttribute("aria-disabled");
	            } else {
	              el.setAttribute("data-ha-dest", dest);
	              el.removeAttribute("aria-disabled");
	            }
	          } catch (e) {}
	        }

	        function applyRoutes() {
	          try {
	            banner.querySelectorAll("[data-ha-action]").forEach(function (el) {
	              var action = el.getAttribute("data-ha-action");
	              var dest = routes[action];
	              setActionHref(el, dest);
	            });
	          } catch (e) {}
	        }

	        function ensureActionClickHandlers() {
	          try {
	            banner.querySelectorAll("[data-ha-action]").forEach(function (el) {
	              if (el._haClickBound) return;
	              el._haClickBound = true;
	              el.addEventListener("click", function (event) {
	                // Only intercept plain left-click; allow ctrl/cmd/middle clicks to open in a new tab.
	                if (
	                  event.button !== 0 ||
	                  event.metaKey ||
	                  event.ctrlKey ||
	                  event.shiftKey ||
	                  event.altKey
	                ) {
	                  return;
	                }

	                var dest = null;
	                try {
	                  dest = el.getAttribute("data-ha-dest");
	                } catch (e) {
	                  dest = null;
	                }
	                if (!dest) {
	                  event.preventDefault();
	                  event.stopPropagation();
	                  return;
	                }

	                event.preventDefault();
	                event.stopPropagation();
	                // When embedded, avoid navigating the replay iframe to a HealthArchive page
	                // (which would create a nested HealthArchive-in-HealthArchive experience).
	                try {
	                  if (isEmbedded() && window.top) {
	                    window.top.location.href = dest;
	                    return;
	                  }
	                } catch (e) {}
	                window.location.href = dest;
	              });
	            });
	          } catch (e) {}
	        }

	        ensureActionClickHandlers();
	        applyRoutes();

	        var refreshTimer = null;
	        refreshCompareLink = function () {
	          if (refreshTimer) clearTimeout(refreshTimer);
	          refreshTimer = setTimeout(function () {
	            resolveSnapshotAndLatest()
	              .finally(function () {
	                applyRoutes();
	                updateSnapshotSummary();
	              })
	              .catch(function () {});
	          }, 250);
	        };

	        refreshCompareLink();
	      } catch (e) {}
	    }

	    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", inject, { once: true });
    } else {
      inject();
    }
  })();
</script>
