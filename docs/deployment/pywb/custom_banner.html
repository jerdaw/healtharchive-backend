<!--
HealthArchive custom replay banner for pywb (non-framed replay).

Deploy by copying this file to:
  /srv/healtharchive/replay/templates/custom_banner.html

Then restart the replay service:
  sudo systemctl restart healtharchive-replay.service

Note: This template also sends lightweight postMessage events when replay is
embedded inside HealthArchive (iframe) so the frontend can track the current
archived URL for edition switching.
-->

<style id="ha-replay-banner-css">
  #ha-replay-banner {
    position: sticky;
    top: 0;
    z-index: 2147483647;
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(248, 250, 252, 0.82);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
      sans-serif;
    font-size: 12px;
    line-height: 1.2;
    -webkit-font-smoothing: antialiased;
    backdrop-filter: blur(10px) saturate(1.1);
    box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
  }

  #ha-replay-banner::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: -20px;
    height: 24px;
    pointer-events: none;
    background: linear-gradient(
      to bottom,
      rgba(15, 23, 42, 0.02) 0%,
      rgba(15, 23, 42, 0) 100%
    );
  }

  #ha-replay-banner * {
    box-sizing: border-box;
  }

  #ha-replay-banner .ha-replay-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    max-width: 1120px;
    margin: 0 auto;
    padding: 0.65rem 1.25rem;
  }

  #ha-replay-banner .ha-replay-left,
  #ha-replay-banner .ha-replay-right {
    display: flex;
    align-items: center;
    gap: 0.45rem;
    flex-shrink: 0;
  }

  #ha-replay-banner .ha-replay-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.18rem 0.6rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.1);
    border: 1px solid rgba(37, 99, 235, 0.25);
    color: #2563eb;
    font-weight: 650;
    white-space: nowrap;
  }

  #ha-replay-banner .ha-replay-center {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: baseline;
    gap: 0.65rem;
    white-space: nowrap;
    overflow: hidden;
  }

  #ha-replay-banner .ha-replay-meta {
    color: rgba(15, 23, 42, 0.7);
    overflow: hidden;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #ha-replay-banner .ha-replay-disclaimer {
    color: rgba(15, 23, 42, 0.55);
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #ha-replay-banner button {
    appearance: none;
    border: 1px solid transparent;
    background: transparent;
    color: rgba(15, 23, 42, 0.72);
    border-radius: 999px;
    padding: 0.3rem 0.85rem;
    font: inherit;
    font-weight: 550;
    cursor: pointer;
    line-height: 1;
  }

  #ha-replay-banner button {
    transition: background 120ms ease, border-color 120ms ease, transform 120ms ease;
  }

  #ha-replay-banner button:hover {
    color: rgba(15, 23, 42, 0.95);
    transform: translateY(-1px);
    background: rgba(148, 163, 184, 0.16);
  }

  #ha-replay-banner .ha-replay-brand {
    appearance: none;
    border: none;
    background: transparent;
    padding: 0.3rem 0.85rem;
    margin: 0;
    font: inherit;
    font-weight: 600;
    color: rgba(15, 23, 42, 0.95);
    cursor: pointer;
  }

  #ha-replay-banner .ha-replay-brand:hover {
    background: rgba(148, 163, 184, 0.16);
    text-decoration: none;
  }

  #ha-replay-banner .ha-replay-action-link {
    appearance: none;
    border: 1px solid transparent;
    background-color: #2563eb;
    color: #ffffff;
    border-radius: 999px;
    padding: 0.3rem 0.85rem;
    font: inherit;
    font-weight: 550;
    cursor: pointer;
    box-shadow: 0 10px 24px rgba(37, 99, 235, 0.35);
  }

  #ha-replay-banner .ha-replay-action-link:hover {
    background-color: #1d4ed8;
    color: #ffffff;
    text-decoration: none;
  }

  #ha-replay-banner .ha-replay-link {
    padding: 0.3rem 0.85rem;
    font-weight: 550;
    color: rgba(15, 23, 42, 0.72);
  }

  #ha-replay-banner .ha-replay-link:hover {
    color: rgba(15, 23, 42, 0.95);
    background: rgba(148, 163, 184, 0.16);
  }

  #ha-replay-banner .ha-replay-divider {
    width: 1px;
    height: 20px;
    background: rgba(148, 163, 184, 0.35);
  }

  @media (prefers-color-scheme: dark) {
    #ha-replay-banner {
      background: rgba(17, 24, 39, 0.78);
      border-bottom-color: rgba(51, 65, 85, 0.6);
      color: #e8e6e3;
    }

    #ha-replay-banner::after {
      background: linear-gradient(
        to bottom,
        rgba(148, 163, 184, 0.04) 0%,
        rgba(148, 163, 184, 0) 100%
      );
    }

    #ha-replay-banner .ha-replay-pill {
      background: rgba(37, 99, 235, 0.24);
      border-color: rgba(37, 99, 235, 0.35);
      color: rgba(219, 234, 254, 0.95);
    }

    #ha-replay-banner .ha-replay-meta,
    #ha-replay-banner .ha-replay-disclaimer {
      color: rgba(226, 232, 240, 0.75);
    }

    #ha-replay-banner button {
      color: rgba(226, 232, 240, 0.76);
    }

    #ha-replay-banner button:hover {
      background: rgba(148, 163, 184, 0.14);
      color: rgba(226, 232, 240, 0.95);
    }

    #ha-replay-banner .ha-replay-action-link {
      background-color: #2563eb;
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.28);
    }

    #ha-replay-banner .ha-replay-action-link:hover {
      background-color: #1d4ed8;
    }

    #ha-replay-banner .ha-replay-brand {
      color: rgba(226, 232, 240, 0.95);
    }

    #ha-replay-banner .ha-replay-link {
      color: rgba(226, 232, 240, 0.76);
    }

    #ha-replay-banner .ha-replay-link:hover {
      color: rgba(226, 232, 240, 0.95);
      background: rgba(148, 163, 184, 0.14);
    }

    #ha-replay-banner .ha-replay-divider {
      background: rgba(51, 65, 85, 0.6);
    }
  }

  @media (max-width: 780px) {
    #ha-replay-banner .ha-replay-center {
      display: none;
    }
    #ha-replay-banner .ha-replay-divider {
      display: none;
    }
  }
</style>

<script id="ha-replay-banner-js">
  (function () {
    var MESSAGE_TYPE = "haReplayNavigation";
    var SNAPSHOT_STORAGE_KEY = "haReplaySnapshotId";

    function isEmbedded() {
      try {
        return window !== window.top;
      } catch (e) {
        // If we can't access window.top, assume we're embedded.
        return true;
      }
    }

    function sendReplayNavigation() {
      if (!isEmbedded()) return;

      var wb = window.wbinfo || {};
      var payload = {
        type: MESSAGE_TYPE,
        coll: wb.coll || null,
        timestamp: wb.timestamp || null,
        url: wb.url || null,
        topUrl: wb.top_url || null,
      };

      var key = String(payload.coll) + "|" + String(payload.timestamp) + "|" + String(payload.url);
      if (sendReplayNavigation._lastKey === key) return;
      sendReplayNavigation._lastKey = key;

      try {
        window.parent.postMessage(payload, "*");
      } catch (e) {
        // Ignore cross-origin messaging failures.
      }
    }

    if (isEmbedded()) {
      sendReplayNavigation();

      window.addEventListener("pageshow", sendReplayNavigation);
      window.addEventListener("hashchange", sendReplayNavigation);
      window.addEventListener("popstate", sendReplayNavigation);

      try {
        var origPushState = history.pushState;
        var origReplaceState = history.replaceState;

        history.pushState = function () {
          var result = origPushState.apply(this, arguments);
          setTimeout(sendReplayNavigation, 0);
          return result;
        };

        history.replaceState = function () {
          var result = origReplaceState.apply(this, arguments);
          setTimeout(sendReplayNavigation, 0);
          return result;
        };
      } catch (e) {
        // Ignore history patching failures.
      }
    }

    // Only show the banner when replay is opened directly, not when embedded
    // inside the HealthArchive wrapper iframe.
    try {
      if (isEmbedded()) return;
    } catch (e) {
      // If we can't access window.top, assume we're embedded and skip.
      return;
    }

    // Allow the banner UI to be disabled for screenshot generation or debugging.
    // We use a fragment flag (not a query param) because replay URLs already
    // embed the original URL and its query string.
    try {
      if (/ha_nobanner/i.test(window.location.hash || "")) return;
    } catch (e) {
      // Ignore location access failures.
    }

    var STORAGE_KEY = "haReplayBannerDismissed";
    try {
      if (localStorage.getItem(STORAGE_KEY) === "1") return;
    } catch (e) {
      // Ignore storage failures.
    }

    function loadSnapshotId() {
      var raw = "";
      try {
        raw = window.location.hash || "";
      } catch (e) {
        raw = "";
      }
      var hash = raw.replace(/^#/, "");
      var snapshotId = null;
      try {
        var params = new URLSearchParams(hash);
        snapshotId = params.get("ha_snapshot") || params.get("haSnapshot");
      } catch (e) {
        snapshotId = null;
      }

      if (snapshotId) {
        try {
          sessionStorage.setItem(SNAPSHOT_STORAGE_KEY, String(snapshotId));
        } catch (e) {}
        return String(snapshotId);
      }

      try {
        var stored = sessionStorage.getItem(SNAPSHOT_STORAGE_KEY);
        if (stored) return stored;
      } catch (e) {}
      return null;
    }

    function formatTimestamp(ts) {
      if (!ts || typeof ts !== "string" || ts.length < 8) return null;
      var year = Number(ts.slice(0, 4));
      var month = Number(ts.slice(4, 6));
      var day = Number(ts.slice(6, 8));
      if (!year || !month || !day) return null;
      var d = new Date(Date.UTC(year, month - 1, day));
      if (isNaN(d.getTime())) return null;
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    function buildMeta() {
      var wb = window.wbinfo || {};
      var parts = [];
      if (wb.coll) parts.push("Backup: " + wb.coll);
      var capture = formatTimestamp(wb.timestamp);
      if (capture) parts.push("Captured: " + capture);
      return parts.join(" \u00b7 ");
    }

    function inject() {
      if (!document.body) return;

      var banner = document.getElementById("ha-replay-banner");
      if (banner) return;

      var snapshotId = loadSnapshotId();

      banner = document.createElement("div");
      banner.id = "ha-replay-banner";
      banner.setAttribute("role", "region");
      banner.setAttribute("aria-label", "HealthArchive replay notice");

      banner.innerHTML =
        '<div class="ha-replay-inner">' +
        '  <div class="ha-replay-left">' +
        '    <button type="button" class="ha-replay-brand" data-ha-action="home" aria-label="Back to HealthArchive.ca">\u2190 HealthArchive.ca</button>' +
        '    <button type="button" class="ha-replay-action-link" data-ha-action="browse">Browse</button>' +
        '    <span class="ha-replay-pill" aria-label="Archived replay notice">Archived replay</span>' +
        "  </div>" +
        '  <div class="ha-replay-center">' +
        '    <div class="ha-replay-meta" id="ha-replay-meta"></div>' +
        '    <div class="ha-replay-disclaimer">Independent archive \u00b7 Not a government website \u00b7 Content may be outdated</div>' +
        "  </div>" +
        '  <div class="ha-replay-right" id="ha-replay-actions">' +
        (snapshotId
          ? '    <button type="button" class="ha-replay-link" data-ha-action="details">Snapshot details</button>' +
            '    <button type="button" class="ha-replay-link" data-ha-action="raw">Raw HTML</button>' +
            '    <button type="button" class="ha-replay-link" data-ha-action="json">Metadata JSON</button>' +
            '    <span class="ha-replay-divider" aria-hidden="true"></span>'
          : "") +
        '    <button type="button" id="ha-replay-hide" class="ha-replay-link" aria-label="Hide this banner">Hide</button>' +
        "  </div>" +
        "</div>";

      document.body.insertBefore(banner, document.body.firstChild);

      var metaEl = document.getElementById("ha-replay-meta");
      if (metaEl) {
        var meta = buildMeta();
        metaEl.textContent = meta || "";
      }

      var hideBtn = document.getElementById("ha-replay-hide");
      if (hideBtn) {
        hideBtn.addEventListener("click", function () {
          try {
            localStorage.setItem(STORAGE_KEY, "1");
          } catch (e) {}
          var el = document.getElementById("ha-replay-banner");
          if (el && el.parentNode) el.parentNode.removeChild(el);
        });
      }

      // Avoid pywb rewriting our "escape hatch" navigation by:
      //  - not embedding HealthArchive URLs directly in HTML attributes, and
      //  - using buttons with explicit JS navigation.
      try {
        var haBase = "https://" + "www." + "healtharchive.ca";
        var apiBase = "https://" + "api." + "healtharchive.ca";
        var routes = {
          home: haBase + "/",
          browse: haBase + "/archive",
        };

        if (snapshotId) {
          routes.details = haBase + "/snapshot/" + snapshotId;
          routes.raw = apiBase + "/api/snapshots/raw/" + snapshotId;
          routes.json = apiBase + "/api/snapshot/" + snapshotId;
        }

        banner.querySelectorAll("[data-ha-action]").forEach(function (el) {
          el.addEventListener("click", function (event) {
            event.preventDefault();
            event.stopPropagation();
            var action = el.getAttribute("data-ha-action");
            var dest = routes[action];
            if (!dest) return;
            if (action === "home" || action === "browse") {
              window.location.href = dest;
              return;
            }

            try {
              var opened = window.open(dest, "_blank", "noopener,noreferrer");
              if (!opened) window.location.href = dest;
            } catch (e) {
              window.location.href = dest;
            }
          });
        });
      } catch (e) {}
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", inject, { once: true });
    } else {
      inject();
    }
  })();
</script>
