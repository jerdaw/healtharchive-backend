{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "Operator-only aggregate usage (privacy-preserving): daily counts by event from Postgres usage_metrics.",
  "editable": false,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "panels": [
    {
      "datasource": "grafana-postgresql-datasource",
      "description": "Postgres: daily counts for core events (search + snapshot views).",
      "fieldConfig": {
        "defaults": {
          "unit": "none"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom"
        }
      },
      "targets": [
        {
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\\n  metric_date::timestamp AS time,\\n  event AS metric,\\n  count::bigint AS value\\nFROM usage_metrics\\nWHERE $__timeFilter(metric_date::timestamp)\\n  AND event IN ('search_request', 'snapshot_detail', 'snapshot_raw')\\nORDER BY metric_date;",
          "refId": "A"
        }
      ],
      "title": "Daily Usage (core events)",
      "type": "timeseries"
    },
    {
      "datasource": "grafana-postgresql-datasource",
      "description": "Postgres: daily counts for engagement/advanced events (reports, changes, exports).",
      "fieldConfig": {
        "defaults": {
          "unit": "none"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 10
      },
      "id": 2,
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom"
        }
      },
      "targets": [
        {
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\\n  metric_date::timestamp AS time,\\n  event AS metric,\\n  count::bigint AS value\\nFROM usage_metrics\\nWHERE $__timeFilter(metric_date::timestamp)\\n  AND event IN ('report_submitted', 'changes_list', 'compare_view', 'timeline_view', 'exports_download_snapshots', 'exports_download_changes')\\nORDER BY metric_date;",
          "refId": "A"
        }
      ],
      "title": "Daily Usage (engagement + advanced events)",
      "type": "timeseries"
    },
    {
      "datasource": "grafana-postgresql-datasource",
      "description": "Postgres: rolling averages for search requests (7d/30d).",
      "fieldConfig": {
        "defaults": {
          "unit": "none"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 14,
        "x": 0,
        "y": 20
      },
      "id": 3,
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom"
        }
      },
      "targets": [
        {
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "WITH daily AS (\\n  SELECT metric_date, SUM(count)::bigint AS count\\n  FROM usage_metrics\\n  WHERE event = 'search_request'\\n  GROUP BY metric_date\\n)\\nSELECT\\n  metric_date::timestamp AS time,\\n  count,\\n  AVG(count) OVER (ORDER BY metric_date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS avg_7d,\\n  AVG(count) OVER (ORDER BY metric_date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW) AS avg_30d\\nFROM daily\\nWHERE $__timeFilter(metric_date::timestamp)\\nORDER BY metric_date;",
          "refId": "A"
        }
      ],
      "title": "Search Requests (daily + rolling averages)",
      "type": "timeseries"
    },
    {
      "datasource": "grafana-postgresql-datasource",
      "description": "Postgres: totals by event over the last 30 days.",
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 10,
        "x": 14,
        "y": 20
      },
      "id": 4,
      "options": {
        "showHeader": true
      },
      "targets": [
        {
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\\n  event,\\n  SUM(count)::bigint AS count_30d\\nFROM usage_metrics\\nWHERE metric_date >= (current_date - INTERVAL '30 days')\\nGROUP BY event\\nORDER BY count_30d DESC;",
          "refId": "A"
        }
      ],
      "title": "Totals by Event (last 30 days)",
      "type": "table"
    }
  ],
  "refresh": "5m",
  "schemaVersion": 39,
  "tags": [
    "healtharchive",
    "usage",
    "private"
  ],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-180d",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "utc",
  "title": "HealthArchive - Usage (Private, Aggregate)",
  "uid": "ha-usage-private",
  "version": 1
}
