groups:
  - name: healtharchive.core
    rules:
      - alert: HealthArchiveBackendScrapeDown
        expr: up{job="healtharchive_backend"} == 0
        for: 5m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "HealthArchive backend metrics scrape is down"
          description: "Prometheus cannot scrape /metrics from the backend for 5m. Check healtharchive-api.service and admin token config."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/incident-response.md"

      - alert: HealthArchiveDiskUsageHigh
        expr: |
          (100 - (node_filesystem_avail_bytes{mountpoint="__MOUNTPOINT__",fstype!~"tmpfs|overlay"} /
          node_filesystem_size_bytes{mountpoint="__MOUNTPOINT__",fstype!~"tmpfs|overlay"} * 100)) > 85
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Disk usage > 85% on __MOUNTPOINT__"
          description: "Disk usage has been > 85% for 30m on the filesystem backing __MOUNTPOINT__. Baseline is ~82% with automated cleanup; sustained usage above 85% indicates accumulation. Check Docker images, logs, and temp crawl dirs."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/incident-response.md"

      - alert: HealthArchiveDiskUsageCritical
        expr: |
          (100 - (node_filesystem_avail_bytes{mountpoint="__MOUNTPOINT__",fstype!~"tmpfs|overlay"} /
          node_filesystem_size_bytes{mountpoint="__MOUNTPOINT__",fstype!~"tmpfs|overlay"} * 100)) > 92
        for: 10m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Disk usage > 92% on __MOUNTPOINT__"
          description: "Disk usage has been > 92% for 10m on the filesystem backing __MOUNTPOINT__. Immediate action required: run docker-cleanup.sh, truncate container logs, or stop crawls to prevent disk-full failures."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/incident-response.md"

      - alert: HealthArchiveSearchErrorsSustained
        expr: |
          increase(healtharchive_search_errors_total[15m]) >= 3
          and increase(healtharchive_search_requests_total[15m]) >= 50
        for: 10m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Sustained /api/search errors"
          description: "At least 3 search errors over 15m with meaningful traffic (>=50 requests). Investigate recent deploys, DB health, and logs."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/incident-response.md"

      - alert: HealthArchiveJobFailuresIncreased
        expr: |
          delta(healtharchive_jobs_total{status=~"failed|index_failed"}[30m]) > 0
        for: 5m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Job failures increased"
          description: "The number of jobs in failed/index_failed increased in the last 30m. Check admin jobs list for the most recent failures and error messages."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/incident-response.md"

  - name: healtharchive.crawl
    rules:
      - alert: HealthArchiveCrawlMetricsMissing
        expr: healtharchive_crawl_metrics_ok == 0
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Crawl metrics textfile writer failing"
          description: "The crawl metrics textfile script is failing (healtharchive_crawl_metrics_ok==0). Check healtharchive-crawl-metrics.service logs and storage mount health."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveWorkerDownWhileJobsPending
        expr: |
          healtharchive_worker_should_be_running == 1
          and healtharchive_worker_active == 0
        for: 10m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Worker is down while crawl jobs are pending"
          description: "There are pending crawl jobs (queued/retryable) and Storage Box appears readable, but healtharchive-worker.service is not active. Check worker logs, Storage Box hot-path health, and recent deploy activity."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-recovery.md"

      - alert: HealthArchiveCrawlOutputDirUnreadable
        expr: healtharchive_crawl_running_job_output_dir_ok == 0
        for: 2m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Running job output dir unreadable"
          description: "A running crawl job has an unreadable output_dir: source={{ $labels.source }} job_id={{ $labels.job_id }}. Check healtharchive_crawl_running_job_output_dir_errno (Errno 107 usually indicates a stale sshfs mount)."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-recovery.md"

      - alert: HealthArchiveAnnualOutputDirNotWritable
        expr: |
          healtharchive_crawl_annual_pending_output_dir_probe_user_ok == 1
          and healtharchive_crawl_annual_pending_job_output_dir_writable == 0
        for: 10m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Annual job output dir not writable (queued/retryable)"
          description: "A queued/retryable annual job output_dir is not writable: source={{ $labels.source }} job_id={{ $labels.job_id }} status={{ $labels.status }} year={{ $labels.year }}. Check healtharchive_crawl_annual_pending_job_output_dir_writable_errno (Errno 13 indicates permissions; Errno 107 indicates stale sshfs)."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/crawl/crawl-preflight.md"

      - alert: HealthArchiveCrawlStateFileParseFailed
        expr: |
          healtharchive_crawl_running_job_state_file_ok == 1
          and healtharchive_crawl_running_job_state_parse_ok == 0
        for: 10m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Running job state file unreadable/unparseable"
          description: "A running job has a .archive_state.json file but it is failing to parse. This can indicate partial writes, storage errors, or unexpected schema changes. job_id={{ $labels.job_id }} source={{ $labels.source }}."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveCrawlStalled
        expr: healtharchive_crawl_running_job_stalled == 1
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Crawl progress stalled (no crawled-count increase)"
          description: "A running crawl job appears stalled: source={{ $labels.source }} job_id={{ $labels.job_id }}. Check healtharchive-worker.service logs and the job's archive_*.combined.log; consider recovering the job if it remains stalled."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/crawl-stalls.md"

      - alert: HealthArchiveCrawlContainerRestartsHigh
        expr: healtharchive_crawl_running_job_container_restarts_done >= 10
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "High container restart count during crawl"
          description: "A running job has performed many container restarts (adaptive restart). job_id={{ $labels.job_id }} source={{ $labels.source }} restarts={{ $value }}."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveCrawlNewPhaseChurn
        expr: healtharchive_crawl_running_job_new_crawl_phase_count >= 3
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Repeated new crawl phase transitions"
          description: "A running crawl job has repeatedly fallen back to 'New Crawl Phase' in the current combined-log window. This can indicate resume/frontier instability and can hurt long-run completeness efficiency. job_id={{ $labels.job_id }} source={{ $labels.source }} count={{ $value }}."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveIndexingNotStarted
        expr: healtharchive_indexing_pending_job_max_age_seconds > 3600
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Crawl completed but indexing not starting"
          description: "At least one job has status=completed for over an hour (crawl done, indexing not done). Check healtharchive-worker.service and worker logs."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/annual-campaign.md"

      - alert: HealthArchiveCrawlRateSlowHC
        expr: |
          healtharchive_crawl_running_job_progress_known{source="hc"} == 1
          and healtharchive_crawl_running_job_crawl_rate_ppm{source="hc"} >= 0
          and healtharchive_crawl_running_job_crawl_rate_ppm{source="hc"} < 1.5
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "HC crawl rate is very slow"
          description: "A running HC crawl job has a very low crawl rate (<1.5 pages/min): source={{ $labels.source }} job_id={{ $labels.job_id }} rate={{ $value }}ppm. This can indicate network issues, storage instability, or resume/frontier churn."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveCrawlRateSlowPHAC
        expr: |
          healtharchive_crawl_running_job_progress_known{source="phac"} == 1
          and healtharchive_crawl_running_job_crawl_rate_ppm{source="phac"} >= 0
          and healtharchive_crawl_running_job_crawl_rate_ppm{source="phac"} < 1.5
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "PHAC crawl rate is very slow"
          description: "A running PHAC crawl job has a very low crawl rate (<1.5 pages/min): source={{ $labels.source }} job_id={{ $labels.job_id }} rate={{ $value }}ppm. This can indicate persistent blocking/noise or infrastructure instability."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveCrawlRateSlowCIHR
        expr: |
          healtharchive_crawl_running_job_progress_known{source="cihr"} == 1
          and healtharchive_crawl_running_job_crawl_rate_ppm{source="cihr"} >= 0
          and healtharchive_crawl_running_job_crawl_rate_ppm{source="cihr"} < 3
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "CIHR crawl rate is very slow"
          description: "A running CIHR crawl job has a very low crawl rate (<3 pages/min): source={{ $labels.source }} job_id={{ $labels.job_id }} rate={{ $value }}ppm. CIHR is expected to run faster than canada.ca profiles; sustained low rate warrants investigation."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

      - alert: HealthArchiveInfraErrorsHigh
        expr: healtharchive_jobs_infra_error_recent_total{window="10m"} >= 3
        for: 5m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "High rate of infrastructure errors"
          description: "Multiple jobs (>=3) have failed with infra_error in the last 10 minutes. This typically indicates Storage Box mount issues, network problems, or storage capacity issues. Check mount health and storage connectivity."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-recovery.md"

      - alert: HealthArchiveCrawlMetricsStale
        expr: (time() - healtharchive_crawl_metrics_timestamp_seconds) > 600
        for: 5m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Crawl metrics are stale"
          description: "No crawl metrics update in over 10 minutes. The healtharchive-crawl-metrics.timer may be failing or the textfile collector may not be running. Check healtharchive-crawl-metrics.service logs."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/tutorials/debug-crawl.md"

  - name: healtharchive.tiering
    rules:
      - alert: HealthArchiveStorageBoxMountDown
        expr: healtharchive_storagebox_mount_ok == 0
        for: 2m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Storage Box mount is down (cold WARC tier unavailable)"
          description: "The Storage Box mount is missing or unreadable. Replay and/or crawls that rely on cold WARCs may fail. Check healtharchive-storagebox-sshfs.service and the sshfs mount."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/warc-storage-tiering.md"

      - alert: HealthArchiveStorageHotpathStaleUnrecovered
        expr: |
          healtharchive_storage_hotpath_auto_recover_enabled == 1
          and healtharchive_storage_hotpath_auto_recover_detected_targets > 0
        for: 10m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Storage hot path stale/unrecovered (Errno 107 likely)"
          description: "The Storage Box hot-path auto-recover script is enabled but still detects stale/unreadable hot paths (Errno 107) after 10m. Check /srv/healtharchive/ops/watchdog/storage-hotpath-auto-recover.json and consider manual unmount + tiering re-apply."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-recovery.md"

      - alert: HealthArchiveStorageHotpathApplyFailedPersistent
        expr: |
          healtharchive_storage_hotpath_auto_recover_enabled == 1
          and healtharchive_storage_hotpath_auto_recover_apply_total > 0
          and healtharchive_storage_hotpath_auto_recover_last_apply_ok == 0
          and (time() - healtharchive_storage_hotpath_auto_recover_last_apply_timestamp_seconds) > 86400
        for: 30m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Storage hot-path auto-recover apply failed for >24h"
          description: "The last apply-mode hot-path recovery failed and no successful apply has replaced it for over 24 hours. Check /srv/healtharchive/ops/watchdog/storage-hotpath-auto-recover.json (last_apply_errors, last_apply_warnings), then run stale-mount recovery playbook steps."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-recovery.md"

      - alert: HealthArchiveTieringHotPathUnreadable
        expr: healtharchive_tiering_hot_path_ok == 0
        for: 2m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Tiering hot path unreadable (stale sshfs mount?)"
          description: "A tiering hot path is unreadable: hot={{ $labels.hot }}. Check healtharchive_tiering_hot_path_errno (Errno 107 usually indicates a stale sshfs mount)."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-recovery.md"

      - alert: HealthArchiveWarcTieringFailed
        expr: healtharchive_systemd_unit_failed{unit="healtharchive-warc-tiering.service"} == 1
        for: 1m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "WARC tiering bind mounts failed"
          description: "The tiering bind-mount service is in a failed state. Canonical WARC paths may not resolve after reboot. Check healtharchive-warc-tiering.service logs and /etc/healtharchive/warc-tiering.binds."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/warc-storage-tiering.md"

      - alert: HealthArchiveTieringStale
        expr: (time() - healtharchive_tiering_metrics_timestamp_seconds) > 7200
        for: 10m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "HealthArchive tiering metrics are stale"
          description: "No successful tiering metrics update in over 2 hours. Timer may be failing."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/incident-response.md"

  - name: healtharchive.campaign
    rules:
      - alert: HealthArchiveAnnualCampaignSentinelFailed
        expr: |
          healtharchive_annual_campaign_sentinel_ok == 0
          and (time() - healtharchive_annual_campaign_sentinel_last_run_timestamp_seconds) < 7200
          and on() month() == 1
          and on() day_of_month() == 1
        for: 2m
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Annual campaign sentinel failed (preflight/scheduling/tiering)"
          description: "The annual campaign sentinel reported failure. This usually means campaign preflight failed, annual jobs were not scheduled, or annual output dirs were not tiered onto the Storage Box."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/annual-campaign.md"

      - alert: HealthArchiveAnnualCampaignSentinelMissing
        expr: |
          (
            absent(healtharchive_annual_campaign_sentinel_last_run_timestamp_seconds)
            or (
              year(max(healtharchive_annual_campaign_sentinel_last_run_timestamp_seconds)) != on() year()
              or month(max(healtharchive_annual_campaign_sentinel_last_run_timestamp_seconds)) != on() month()
              or day_of_month(max(healtharchive_annual_campaign_sentinel_last_run_timestamp_seconds)) != on() day_of_month()
            )
          )
          and on() month() == 1
          and on() day_of_month() == 1
        for: 1h
        labels:
          severity: critical
          service: healtharchive
        annotations:
          summary: "Annual campaign sentinel did not run"
          description: "No annual campaign sentinel metrics were observed on Jan 01. Check that healtharchive-annual-campaign-sentinel.timer is enabled and node_exporter textfile collector is working."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/annual-campaign.md"

  - name: healtharchive.automation
    rules:
      - alert: HealthArchiveCoverageRegression
        expr: healtharchive_coverage_regression == 1
        for: 6h
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Annual coverage regression detected"
          description: "Coverage ratio dropped below the configured threshold for source={{ $labels.source }} year={{ $labels.year }}. Review annual job logs and compare with prior year."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/coverage-guardrails.md"

      - alert: HealthArchiveCoverageMetricsMissing
        expr: healtharchive_coverage_metrics_ok == 0
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Coverage guardrails metrics missing"
          description: "Coverage guardrails metrics script failed. Check healtharchive-coverage-guardrails.service logs and configuration."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/coverage-guardrails.md"

      - alert: HealthArchiveReplaySmokeFailed
        expr: |
          healtharchive_replay_smoke_ok == 0
          and on() healtharchive_replay_smoke_enabled == 1
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Replay smoke test failed"
          description: "Replay smoke check failed for source={{ $labels.source }} job_id={{ $labels.job_id }}. Check replay health and replay-reconcile."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/replay-smoke-tests.md"

      - alert: HealthArchiveReplaySmokeMetricsMissing
        expr: healtharchive_replay_smoke_metrics_ok == 0
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Replay smoke metrics missing"
          description: "Replay smoke metrics script failed. Check healtharchive-replay-smoke.service logs and configuration."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/replay-smoke-tests.md"

      - alert: HealthArchiveCleanupAutomationErrors
        expr: healtharchive_cleanup_apply_errors_total > 0
        for: 10m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Cleanup automation encountered errors"
          description: "One or more cleanup-job runs failed. Check healtharchive-cleanup-automation.service logs and inspect the affected job IDs."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/cleanup-automation.md"

      - alert: HealthArchiveCleanupMetricsMissing
        expr: healtharchive_cleanup_metrics_ok == 0
        for: 15m
        labels:
          severity: warning
          service: healtharchive
        annotations:
          summary: "Cleanup automation metrics missing"
          description: "Cleanup automation metrics script failed. Check healtharchive-cleanup-automation.service logs and configuration."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/cleanup-automation.md"

  - name: healtharchive.drills
    rules:
      - alert: HealthArchiveAlertPipelineDrill
        expr: healtharchive_alert_pipeline_drill == 1
        for: 30s
        labels:
          severity: drill
          service: healtharchive
        annotations:
          summary: "Drill: alert pipeline test"
          description: "This alert is intentionally triggered during operator drills to validate Prometheusâ†’Alertmanager wiring. It should be routed to a null receiver by default."
          runbook_url: "https://github.com/jerdaw/healtharchive-backend/blob/main/docs/operations/playbooks/storagebox-sshfs-stale-mount-drills.md"
