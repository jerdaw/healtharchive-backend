<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://docs.healtharchive.ca/roadmaps/implemented/2026-01-03-search-ranking-and-snippets-v3/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Search ranking + snippet quality iteration (v3) — implementation plan - HealthArchive</title><link rel=stylesheet href=../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Search ranking + snippet quality iteration (v3) — implementation plan - HealthArchive"><meta property=og:image content=https://docs.healtharchive.ca/assets/images/social/roadmaps/implemented/2026-01-03-search-ranking-and-snippets-v3.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://docs.healtharchive.ca/roadmaps/implemented/2026-01-03-search-ranking-and-snippets-v3/ property=og:url><meta property=twitter:card content=summary_large_image><meta property=twitter:title content="Search ranking + snippet quality iteration (v3) — implementation plan - HealthArchive"><meta property=twitter:image content=https://docs.healtharchive.ca/assets/images/social/roadmaps/implemented/2026-01-03-search-ranking-and-snippets-v3.png></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#search-ranking-snippet-quality-iteration-v3-implementation-plan class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=HealthArchive class="md-header__button md-logo" aria-label=HealthArchive data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> HealthArchive </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Search ranking + snippet quality iteration (v3) — implementation plan </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jerdaw/healtharchive-backend title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> jerdaw/healtharchive-backend </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../quickstart/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../../tutorials/first-contribution/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../../operations/ class=md-tabs__link> How-To Guides </a> </li> <li class=md-tabs__item> <a href=../../../api/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../../documentation-guidelines/ class=md-tabs__link> Explanation </a> </li> <li class=md-tabs__item> <a href=../../ class=md-tabs__link> Planning & Roadmaps </a> </li> <li class=md-tabs__item> <a href=../../../project/ class=md-tabs__link> About </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=HealthArchive class="md-nav__button md-logo" aria-label=HealthArchive data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> HealthArchive </label> <div class=md-nav__source> <a href=https://github.com/jerdaw/healtharchive-backend title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> jerdaw/healtharchive-backend </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../quickstart/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class=md-nav__item> <a href=../../../project/ class=md-nav__link> <span class=md-ellipsis> Project Overview </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> Choose Your Path </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Choose Your Path </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/operator-responsibilities/ class=md-nav__link> <span class=md-ellipsis> I'm an Operator </span> </a> </li> <li class=md-nav__item> <a href=../../../development/dev-environment-setup/ class=md-nav__link> <span class=md-ellipsis> I'm a Developer </span> </a> </li> <li class=md-nav__item> <a href=../../../api-consumer-guide/ class=md-nav__link> <span class=md-ellipsis> I'm an API Consumer </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tutorials/first-contribution/ class=md-nav__link> <span class=md-ellipsis> Your First Contribution </span> </a> </li> <li class=md-nav__item> <a href=../../../tutorials/architecture-walkthrough/ class=md-nav__link> <span class=md-ellipsis> Architecture Walkthrough </span> </a> </li> <li class=md-nav__item> <a href=../../../tutorials/debug-crawl/ class=md-nav__link> <span class=md-ellipsis> Debugging a Failed Crawl </span> </a> </li> <li class=md-nav__item> <a href=../../../development/live-testing/ class=md-nav__link> <span class=md-ellipsis> Local Development Workflow </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> How-To Guides </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> How-To Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1> <div class="md-nav__link md-nav__container"> <a href=../../../operations/ class="md-nav__link "> <span class=md-ellipsis> Operations </span> </a> <label class="md-nav__link " for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_2> <label class=md-nav__link for=__nav_4_1_2 id=__nav_4_1_2_label tabindex=0> <span class=md-ellipsis> Core Playbooks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_2> <span class="md-nav__icon md-icon"></span> Core Playbooks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/operator-responsibilities/ class=md-nav__link> <span class=md-ellipsis> I'm an Operator </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/deploy-and-verify/ class=md-nav__link> <span class=md-ellipsis> Deploy & Verify </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/incident-response/ class=md-nav__link> <span class=md-ellipsis> Incident Response </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/escalation-procedures/ class=md-nav__link> <span class=md-ellipsis> Escalation Procedures </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_3> <label class=md-nav__link for=__nav_4_1_3 id=__nav_4_1_3_label tabindex=0> <span class=md-ellipsis> Observability </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_3> <span class="md-nav__icon md-icon"></span> Observability </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/check-logs-api-worker-access.md class=md-nav__link> <span class=md-ellipsis> Check Logs </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/verify-search-index-coverage.md class=md-nav__link> <span class=md-ellipsis> Verify Search Index </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/check-warc-tiering-status.md class=md-nav__link> <span class=md-ellipsis> Monitor WARC Tiering </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/check-disk-space.md class=md-nav__link> <span class=md-ellipsis> Check Disk Space </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/check-healthchecks-io-status.md class=md-nav__link> <span class=md-ellipsis> Check Healthchecks </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/check-tailscale-connectivity.md class=md-nav__link> <span class=md-ellipsis> Check Tailscale </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/review-prometheus-metrics.md class=md-nav__link> <span class=md-ellipsis> Review Metrics </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_4> <label class=md-nav__link for=__nav_4_1_4 id=__nav_4_1_4_label tabindex=0> <span class=md-ellipsis> Crawls & Archives </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_4> <span class="md-nav__icon md-icon"></span> Crawls & Archives </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/validate-export-integrity.md class=md-nav__link> <span class=md-ellipsis> Validate Export Integrity </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/reconcile-replay-collection.md class=md-nav__link> <span class=md-ellipsis> Reconcile Replay Collection </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/reindex-job-warcs.md class=md-nav__link> <span class=md-ellipsis> Reindex Job WARCs </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/trigger-manual-crawl.md class=md-nav__link> <span class=md-ellipsis> Trigger Manual Crawl </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_5> <label class=md-nav__link for=__nav_4_1_5 id=__nav_4_1_5_label tabindex=0> <span class=md-ellipsis> Storage </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_5> <span class="md-nav__icon md-icon"></span> Storage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/check-tailnet-storage-quota.md class=md-nav__link> <span class=md-ellipsis> Check Storage Quotas </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/manage-warc-cleanup.md class=md-nav__link> <span class=md-ellipsis> Manage WARC Cleanup </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/verify-warc-tier-distribution.md class=md-nav__link> <span class=md-ellipsis> Verify WARC Tier Distribution </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_6> <label class=md-nav__link for=__nav_4_1_6 id=__nav_4_1_6_label tabindex=0> <span class=md-ellipsis> Validation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_6> <span class="md-nav__icon md-icon"></span> Validation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/restore-test/ class=md-nav__link> <span class=md-ellipsis> Restore Test </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/verify-coverage.md class=md-nav__link> <span class=md-ellipsis> Verify Coverage </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/dataset-release/ class=md-nav__link> <span class=md-ellipsis> Dataset Release </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/baseline-drift-check.md class=md-nav__link> <span class=md-ellipsis> Baseline Drift Check </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/verify-ops-automation.md class=md-nav__link> <span class=md-ellipsis> Verify Ops Automation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_7> <label class=md-nav__link for=__nav_4_1_7 id=__nav_4_1_7_label tabindex=0> <span class=md-ellipsis> External </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_7_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_7> <span class="md-nav__icon md-icon"></span> External </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/playbooks/adoption-signals/ class=md-nav__link> <span class=md-ellipsis> Adoption Signals </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/write-changelog-entry.md class=md-nav__link> <span class=md-ellipsis> Write Changelog Entry </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/playbooks/handle-user-issue-report.md class=md-nav__link> <span class=md-ellipsis> Handle User Issue Report </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../operations/service-levels/ class=md-nav__link> <span class=md-ellipsis> Service Levels </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../development/dev-environment-setup/ class=md-nav__link> <span class=md-ellipsis> I'm a Developer </span> </a> </li> <li class=md-nav__item> <a href=../../../development/testing-guidelines/ class=md-nav__link> <span class=md-ellipsis> Run Tests </span> </a> </li> <li class=md-nav__item> <a href=../../../development/playbooks/database-migrations.md class=md-nav__link> <span class=md-ellipsis> Making Database Changes </span> </a> </li> <li class=md-nav__item> <a href=../../../development/playbooks/add-cli-command.md class=md-nav__link> <span class=md-ellipsis> Adding New CLI Commands </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_3> <div class="md-nav__link md-nav__container"> <a href=../../../deployment/systemd/ class="md-nav__link "> <span class=md-ellipsis> Deployment </span> </a> <label class="md-nav__link " for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Deployment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../deployment/production-single-vps/ class=md-nav__link> <span class=md-ellipsis> Production Setup </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/environments-and-configuration/ class=md-nav__link> <span class=md-ellipsis> Configure Environments </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/hosting-and-live-server-to-dos/ class=md-nav__link> <span class=md-ellipsis> Deploy to Production </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/production-rollout-checklist/ class=md-nav__link> <span class=md-ellipsis> Rollout Checklist </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/replay-service-pywb/ class=md-nav__link> <span class=md-ellipsis> Setup Replay Service </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/search-rollout/ class=md-nav__link> <span class=md-ellipsis> Enable Search V2 </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/pages-table-rollout/ class=md-nav__link> <span class=md-ellipsis> Setup Pages Table </span> </a> </li> <li class=md-nav__item> <a href=../../../deployment/disaster-recovery/ class=md-nav__link> <span class=md-ellipsis> Disaster Recovery </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../../../datasets-external/ class="md-nav__link "> <span class=md-ellipsis> Reference </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../api/ class=md-nav__link> <span class=md-ellipsis> API Documentation </span> </a> </li> <li class=md-nav__item> <a href=../../../architecture/ class=md-nav__link> <span class=md-ellipsis> Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../reference/data-model/ class=md-nav__link> <span class=md-ellipsis> Data Model </span> </a> </li> <li class=md-nav__item> <a href=../../../reference/archive-tool/ class=md-nav__link> <span class=md-ellipsis> Archive Tool </span> </a> </li> <li class=md-nav__item> <a href=../../../reference/cli-commands/ class=md-nav__link> <span class=md-ellipsis> CLI Commands </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_6> <div class="md-nav__link md-nav__container"> <a href=../../../deployment/systemd/ class="md-nav__link "> <span class=md-ellipsis> Configuration </span> </a> <label class="md-nav__link " for=__nav_5_6 id=__nav_5_6_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../deployment/environments-and-configuration/ class=md-nav__link> <span class=md-ellipsis> Configure Environments </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_8> <div class="md-nav__link md-nav__container"> <a href=../../../frontend-external/ class="md-nav__link "> <span class=md-ellipsis> Frontend </span> </a> <label class="md-nav__link " for=__nav_5_8 id=__nav_5_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Frontend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../frontend-external/i18n/ class=md-nav__link> <span class=md-ellipsis> I18n Guide </span> </a> </li> <li class=md-nav__item> <a href=../../../frontend-external/implementation-guide/ class=md-nav__link> <span class=md-ellipsis> Implementation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <div class="md-nav__link md-nav__container"> <a href=../../../decisions/ class="md-nav__link "> <span class=md-ellipsis> Explanation </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Explanation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../documentation-guidelines/ class=md-nav__link> <span class=md-ellipsis> Documentation Guidelines </span> </a> </li> <li class=md-nav__item> <a href=../../../documentation-process-audit/ class=md-nav__link> <span class=md-ellipsis> Documentation Audit </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/ops-cadence-checklist/ class=md-nav__link> <span class=md-ellipsis> Ops Cadence </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/monitoring-and-ci-checklist/ class=md-nav__link> <span class=md-ellipsis> Monitoring Checklist </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/risk-register/ class=md-nav__link> <span class=md-ellipsis> Risk Register </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/baseline-drift/ class=md-nav__link> <span class=md-ellipsis> Baseline Drift </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/data-handling-and-retention.md class=md-nav__link> <span class=md-ellipsis> Data Handling </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/automation.md class=md-nav__link> <span class=md-ellipsis> Automation </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_10> <div class="md-nav__link md-nav__container"> <a href=../../../operations/incidents/ class="md-nav__link "> <span class=md-ellipsis> Incident Management </span> </a> <label class="md-nav__link " for=__nav_6_10 id=__nav_6_10_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_10_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10> <span class="md-nav__icon md-icon"></span> Incident Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/incidents/severity/ class=md-nav__link> <span class=md-ellipsis> Severity Guide </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_10_3> <label class=md-nav__link for=__nav_6_10_3 id=__nav_6_10_3_label tabindex=0> <span class=md-ellipsis> Post-Mortems </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_6_10_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10_3> <span class="md-nav__icon md-icon"></span> Post-Mortems </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/incidents/2026-01-08-storage-hotpath-sshfs-stale-mount/ class=md-nav__link> <span class=md-ellipsis> Storage Hotpath (2026-01-08) </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/incidents/2026-01-09-annual-crawl-hc-job-stalled/ class=md-nav__link> <span class=md-ellipsis> Annual Crawl Stalled (2026-01-09) </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/incidents/2026-01-09-annual-crawl-phac-output-dir-permission-denied/ class=md-nav__link> <span class=md-ellipsis> PHAC Permission Denied (2026-01-09) </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/incidents/2026-01-16-replay-smoke-503-and-warctieringfailed/ class=md-nav__link> <span class=md-ellipsis> Replay Smoke 503 (2026-01-16) </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> Planning & Roadmaps </span> </a> <label class="md-nav__link " for=__nav_7 id=__nav_7_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Planning & Roadmaps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roadmap/ class=md-nav__link> <span class=md-ellipsis> Future Roadmap </span> </a> </li> <li class=md-nav__item> <a href=../../../roadmap-process/ class=md-nav__link> <span class=md-ellipsis> Roadmap Process </span> </a> </li> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Implemented Plans </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <div class="md-nav__link md-nav__container"> <a href=../../../_templates/ class="md-nav__link "> <span class=md-ellipsis> About </span> </a> <label class="md-nav__link " for=__nav_8 id=__nav_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> About </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../project/ class=md-nav__link> <span class=md-ellipsis> Project Overview </span> </a> </li> <li class=md-nav__item> <a href=../../../CONTRIBUTING.md class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../../../meta/documentation-health/ class=md-nav__link> <span class=md-ellipsis> Documentation Health </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=search-ranking-snippet-quality-iteration-v3-implementation-plan>Search ranking + snippet quality iteration (v3) — implementation plan</h1> <p>Status: <strong>Completed</strong> (2026-01-18)</p> <p>Note: <strong>Do not deploy/implement this plan on the production VPS until the annual scrape/crawl is finished and the campaign jobs are <code>indexed</code>.</strong></p> <h2 id=goal>Goal</h2> <p>Iterate on:</p> <ul> <li><strong>Search relevance</strong> (especially broad “hub intent” queries like <code>covid</code>) using Postgres FTS + lightweight heuristics, without introducing a separate search service.</li> <li><strong>Snippet quality</strong> so results “feel human” (less navigation/cookie/banner boilerplate; more meaningful page content).</li> </ul> <p>Deliver this as:</p> <ul> <li>A new ranking version <strong>v3</strong> (opt-in via <code>ranking=v3</code>, later set as default via <code>HA_SEARCH_RANKING_VERSION=v3</code> after evaluation).</li> <li>Index-time extraction improvements for <code>Snapshot.title</code> / <code>Snapshot.snippet</code> / <code>Snapshot.language</code> (and optionally a derived archived flag), with safe refresh/backfill workflows.</li> <li>A repeatable, artifacts-backed evaluation loop using existing golden query tooling.</li> </ul> <p>This plan is intentionally <strong>sequential</strong>: complete each phase before starting the next.</p> <h2 id=why-this-is-next-roadmap-selection>Why this is “next” (roadmap selection)</h2> <p>This is the next highest-leverage item in <code>docs/roadmaps/roadmap.md</code> that is:</p> <ul> <li>Implementable in git (unlike external/IRL partnership work),</li> <li>High impact for core project purpose (research citations + change tracking depend on discoverability),</li> <li>Compatible with single‑VPS constraints and current architecture (Postgres FTS + heuristics),</li> <li>Not “automation work” (explicitly excluded for now).</li> </ul> <h2 id=docs-setup-do-first-before-coding>Docs setup (do first, before coding)</h2> <p>This repo separates backlog vs implementation plans vs canonical docs to avoid drift (see <code>../documentation-guidelines.md</code>).</p> <p>1) <strong>Create this plan doc</strong> - File: <code>docs/roadmaps/2026-01-03-search-ranking-and-snippets-v3.md</code> (this document)</p> <p>2) <strong>Backlog linkage</strong> - Update <code>docs/roadmaps/roadmap.md</code>: - Replace the “Search ranking + snippet quality iteration…” backlog bullet with a link to this plan, marked “in progress”.</p> <p>3) <strong>Roadmaps index</strong> - Update <code>docs/roadmaps/README.md</code> to list this plan under “Implementation plans (active)”.</p> <p>4) <strong>Canonical docs to keep accurate during/after implementation</strong> - Ops evaluation: - <code>docs/operations/search-quality.md</code> - <code>docs/operations/search-golden-queries.md</code> - Deployment/runbooks: - <code>docs/deployment/search-rollout.md</code> (extend from v2 → v3) - <code>docs/architecture.md</code> (search section remains accurate)</p> <p>Rule: keep canonical docs describing <strong>what exists and how to use it</strong>; keep this plan describing <strong>what we will do and in what order</strong>.</p> <hr> <h2 id=scope-goals-constraints>Scope, goals, constraints</h2> <h3 id=in-scope-outcomes-what-we-will-deliver>In-scope outcomes (what we will deliver)</h3> <ul> <li><strong>Snippets that “feel human”</strong> for common queries:</li> <li>less nav/boilerplate (e.g., “Skip to content … Menu … Search …”),</li> <li>more meaningful page body text,</li> <li>stable and reasonably readable across sources.</li> <li><strong>Search relevance improvement</strong> for curated golden queries using repeatable captures + diffs.</li> <li><strong>Ranking version v3</strong>:</li> <li><code>ranking=v3</code> works for <code>/api/search</code> and <code>/api/admin/search-debug</code>,</li> <li>later make v3 the default via <code>HA_SEARCH_RANKING_VERSION=v3</code> after evaluation.</li> <li><strong>Repeatable evaluation artifacts</strong>:</li> <li>captures + diff reports stored outside git (e.g., <code>/srv/healtharchive/ops/search-eval</code>),</li> <li>documented pass/fail rubric for changes.</li> </ul> <h3 id=non-goals-explicitly-out-of-scope>Non-goals (explicitly out of scope)</h3> <ul> <li>No new search infrastructure (no Elasticsearch/Meilisearch/etc.).</li> <li>No query logging system (golden queries remain curated).</li> <li>No ops automation/timers/healthchecks work in this effort.</li> <li>No major re-architecture of WARC storage/replay retention.</li> <li>No large UX redesign (frontend already supports <code>view=pages|snapshots</code>, <code>includeNon2xx</code>, <code>includeDuplicates</code>).</li> </ul> <h3 id=constraints-to-respect-project-resources-policy>Constraints to respect (project resources + policy)</h3> <ul> <li><strong>Single-VPS reality</strong> + Postgres FTS is the core engine (see <code>docs/operations/search-quality.md</code>).</li> <li><strong>Performance budgets</strong> (from <code>docs/operations/growth-constraints.md</code>):</li> <li>Search (view=pages): p95 target &lt; 2s for common queries (regression guardrail).</li> <li><strong>Provenance and trustworthiness</strong>:</li> <li>Index-time metadata changes are allowed, but replay fidelity and WARC linkage must remain intact.</li> <li><strong>Minimal operational complexity</strong>:</li> <li>Rollout and rollback must be simple and reversible.</li> </ul> <hr> <h2 id=current-state-map-what-exists-today-to-build-on>Current-state map (what exists today, to build on)</h2> <h3 id=search-surfaces>Search surfaces</h3> <ul> <li>Public endpoint: <code>GET /api/search</code></li> <li>Implementation: <code>src/ha_backend/api/routes_public.py</code></li> <li>Admin debug endpoint: <code>GET /api/admin/search-debug</code></li> <li>Implementation: <code>src/ha_backend/api/routes_admin.py</code></li> </ul> <h3 id=ranking-versions-and-configuration>Ranking versions and configuration</h3> <ul> <li>Ranking config and query-mode logic:</li> <li><code>src/ha_backend/search_ranking.py</code> (<code>v1</code>, <code>v2</code>)</li> <li>Default ranking via env var:</li> <li><code>HA_SEARCH_RANKING_VERSION</code> (see <code>docs/deployment/search-rollout.md</code>)</li> </ul> <h3 id=golden-query-evaluation-tooling>Golden query evaluation tooling</h3> <ul> <li>Evaluation docs:</li> <li><code>docs/operations/search-quality.md</code></li> <li><code>docs/operations/search-golden-queries.md</code></li> <li>Scripts:</li> <li>Capture: <code>scripts/search-eval-capture.sh</code></li> <li>Capture+diff wrapper: <code>scripts/search-eval-run.sh</code></li> <li>Diff: <code>scripts/search-eval-diff.py</code></li> </ul> <h3 id=snippet-extraction-and-indexing-pipeline>Snippet extraction and indexing pipeline</h3> <ul> <li>HTML → title/text/snippet/language extraction:</li> <li><code>src/ha_backend/indexing/text_extraction.py</code></li> <li>Indexing pipeline uses extraction:</li> <li><code>src/ha_backend/indexing/pipeline.py</code></li> <li>Metadata refresh CLI:</li> <li><code>ha-backend refresh-snapshot-metadata --job-id &lt;ID&gt;</code> (wired in <code>src/ha_backend/cli.py</code>)</li> </ul> <h3 id=tests-to-extend-existing-coverage>Tests to extend (existing coverage)</h3> <ul> <li>Search API behavior:</li> <li><code>tests/test_api_search_and_snapshot.py</code></li> <li>Admin search debug coverage:</li> <li><code>tests/test_admin_search_debug.py</code></li> <li>Fuzzy search:</li> <li><code>tests/test_search_fuzzy.py</code></li> </ul> <hr> <h2 id=definition-of-done-dod-acceptance-criteria>Definition of Done (DoD) + acceptance criteria</h2> <h3 id=relevance-golden-queries>Relevance (golden queries)</h3> <p>For the curated list in <code>docs/operations/search-golden-queries.md</code>:</p> <ul> <li>Broad queries surface expected hub pages in top 10 <strong>more consistently</strong> under v3 than v2.</li> <li>Anti-results (obvious junk/boilerplate/error surfaces) are <strong>less likely</strong> to appear in top 20 for broad queries.</li> <li>No major regressions for non‑COVID guardrail queries.</li> </ul> <h3 id=snippet-quality>Snippet quality</h3> <p>On a representative sample of results from golden query captures:</p> <ul> <li>Snippets do not frequently start with navigation boilerplate.</li> <li>Snippets contain at least one meaningful sentence/phrase from the page body for common pages.</li> <li>Language detection remains at least as good as today for en/fr smoke tests.</li> </ul> <h3 id=performance-safety>Performance + safety</h3> <ul> <li>No meaningful p95 regression for <code>GET /api/search</code> common queries in production.</li> <li>No API schema breaks; the frontend continues working unchanged.</li> <li>Rollback remains a single env-var flip (same operational safety as v2).</li> </ul> <hr> <h2 id=recommendations-for-key-design-decisions-resolve-before-implementation>Recommendations for key design decisions (resolve before implementation)</h2> <p>These are the recommended choices given HealthArchive goals/purposes, single‑VPS resources, and modern best practices (explicit derived features + reversible rollouts).</p> <h3 id=1-introduce-snapshotis_archived-recommended-yes-small-schema-change>1) Introduce <code>Snapshot.is_archived</code> (recommended: <strong>yes</strong>, small schema change)</h3> <p><strong>Recommendation:</strong> add a dedicated archived flag column (tri-state: <code>NULL</code> unknown, <code>true</code>, <code>false</code>) and compute it at indexing/refresh time from title + HTML/text signals.</p> <p>Why:</p> <ul> <li>Decouples snippet quality work from ranking quality. We want cleaner snippets, but we also want archived detection to remain reliable and explainable.</li> <li>Makes ranking cheaper and more stable than query-time <code>ilike()</code> heuristics over snippet text.</li> <li>Supports future UX or research needs (“include/exclude archived”) without re-parsing HTML.</li> </ul> <p>Operational approach:</p> <ul> <li>Add <code>snapshots.is_archived</code> via Alembic migration.</li> <li>Update index-time extraction to compute it.</li> <li>Backfill existing rows via:</li> <li>targeted <code>refresh-snapshot-metadata --job-id ...</code> on recent/high-impact jobs first, then expand,</li> <li>or a dedicated backfill CLI if refresh is too slow for full history.</li> <li>In ranking:</li> <li>Prefer <code>is_archived</code> when column exists and non-NULL,</li> <li>Fall back to the existing title/snippet heuristics for rows where <code>is_archived IS NULL</code> during the transition window.</li> </ul> <h3 id=2-fts-vector-body-text-length-recommended-4kb-of-cleaned-main-content>2) FTS vector body text length (recommended: <strong>4KB</strong> of cleaned main content)</h3> <p><strong>Recommendation:</strong> feed <strong>~4096 characters</strong> of cleaned main-content text into Postgres FTS vectors, in addition to title and URL, while keeping the UI snippet short (~280 chars).</p> <p>Why:</p> <ul> <li>2KB often under-captures key terms on long guidance pages; 4KB improves recall meaningfully.</li> <li>8KB increases backfill CPU + GIN index size and can unintentionally dilute ranking via length normalization on a small VPS.</li> <li>4KB is a conservative, modern default that still leaves headroom to tune later.</li> </ul> <p>Implementation approach (conceptual):</p> <ul> <li>Keep <code>Snapshot.snippet</code> as UI-facing (short).</li> <li>Compute an internal <code>content_text_for_fts</code> from the extraction pipeline (cleaned main content), then truncate to 4KB before calling <code>to_tsvector</code>.</li> <li>Keep title weight highest; content weight medium; URL weight low (current pattern).</li> </ul> <p>Optional (only if we need flexibility later): add a single env var like <code>HA_SEARCH_VECTOR_BODY_MAX_CHARS</code> defaulting to <code>4096</code>, but avoid config sprawl unless we have a real tuning need.</p> <h3 id=3-minimal-snippet-heuristics-for-canadaca-without-overfitting-recommended-generic-first>3) Minimal snippet heuristics for Canada.ca without overfitting (recommended: <strong>generic-first</strong>)</h3> <p><strong>Recommendation:</strong> implement a small, generic, evidence-driven set of heuristics:</p> <p>1) <strong>DOM pruning (generic)</strong> - Remove <code>script</code>, <code>style</code>, <code>noscript</code> (already). - Remove semantic boilerplate containers: <code>nav</code>, <code>header</code>, <code>footer</code>, <code>aside</code>, <code>form</code> (already). - Add ARIA-role pruning: <code>[role=navigation]</code>, <code>[role=banner]</code>, <code>[role=contentinfo]</code>, <code>[role=search]</code>.</p> <p>2) <strong>Content-root selection (generic)</strong> - Prefer <code>&lt;main&gt;</code> / <code>[role=main]</code>. - Else prefer <code>&lt;article&gt;</code>. - Else choose the “best” container by a simple score: - + text length, - − link density penalty, - − boilerplate phrase penalty.</p> <p>3) <strong>Snippet selection (generic)</strong> - Build snippet from the first “good” paragraph/sentence chunk that: - meets a minimum length threshold, - contains sentence-like punctuation, - does not match a small bilingual boilerplate phrase list (skip links, cookie consent, “menu/search” lines), - is not mostly a list of navigation links.</p> <p>Canada.ca-specific handling should be <strong>additive only if needed</strong>:</p> <ul> <li>Start generic; evaluate.</li> <li>If Canada.ca pages still leak boilerplate consistently, add a <em>very small</em> optional rule set gated by hostname (endswith <code>canada.ca</code>) to drop known WET wrapper regions, but only when they are clearly navigation/boilerplate (high link density, low text).</li> </ul> <p>This avoids overfitting while still acknowledging the archive’s heavy Canada.ca coverage.</p> <hr> <h2 id=phase-1-baseline-capture-problem-inventory-no-behavior-changes-yet>Phase 1 — Baseline capture + problem inventory (no behavior changes yet)</h2> <p>Objective: establish “before” truth for relevance + snippet issues and ensure we can measure improvements.</p> <h3 id=11-lock-the-evaluation-protocol-what-we-always-capture>1.1 Lock the evaluation protocol (what we always capture)</h3> <p>Decide and document (in this plan) the exact capture matrix:</p> <ul> <li>Primary user-facing relevance:</li> <li><code>view=pages</code></li> <li><code>sort=relevance</code></li> <li><code>pageSize=20</code> (or 10; pick once and keep stable)</li> <li>Debugging noise / capture-level issues:</li> <li><code>view=snapshots</code></li> <li><code>sort=relevance</code></li> </ul> <p>Decide how diffs key items:</p> <ul> <li>For <code>view=pages</code>: prefer <code>originalUrl</code> (with URL canonicalization).</li> <li>For <code>view=snapshots</code>: prefer <code>id</code> when URL churn makes comparisons confusing.</li> </ul> <h3 id=12-run-baseline-captures-production>1.2 Run baseline captures (production)</h3> <p>Use the existing scripts; store artifacts outside git.</p> <p>Recommended output directory on the VPS:</p> <ul> <li><code>/srv/healtharchive/ops/search-eval</code></li> </ul> <p>Baseline runs to capture:</p> <ul> <li><code>v1</code> vs <code>v2</code> (explicit <code>ranking=v1</code> and <code>ranking=v2</code>), even if v2 is already default.</li> <li>(Optional) a “default” capture (no <code>ranking=</code>) to confirm env wiring.</li> </ul> <p>Artifacts to keep:</p> <ul> <li>Capture dirs: <code>&lt;run-id&gt;-v1/</code>, <code>&lt;run-id&gt;-v2/</code></li> <li>Diff report: <code>&lt;run-id&gt;.diff.txt</code></li> <li>Notes: <code>&lt;run-id&gt;.notes.md</code> summarizing:</li> <li>top obvious improvements/regressions,</li> <li>snippet failure examples,</li> <li>any surprising anti-results.</li> </ul> <h3 id=13-create-a-snippet-failure-taxonomy-evidence-driven>1.3 Create a snippet failure taxonomy (evidence-driven)</h3> <p>From baseline captures, classify failures with real examples:</p> <ul> <li>Nav/header boilerplate leaks into snippet.</li> <li>Cookie banners / consent text dominates snippet.</li> <li>“Archived page” banner dominates snippet (English/French variants).</li> <li>Empty/near-empty snippet despite content.</li> <li>Garbage whitespace / repeated tokens / broken decoding.</li> </ul> <p>For each category, record 3–10 representative URLs (or snapshot IDs) and the observed snippet text.</p> <h3 id=14-establish-a-lightweight-performance-baseline>1.4 Establish a lightweight performance baseline</h3> <p>Record at least one timing snapshot for:</p> <ul> <li>broad query: <code>covid</code> (<code>view=pages</code>)</li> <li>medium query: <code>covid vaccine</code></li> <li>French query: <code>grippe</code></li> </ul> <p>Goal: detect “obvious” regressions later, not produce a full benchmark suite.</p> <p><strong>Deliverables:</strong></p> <ul> <li>Baseline capture dirs + diff reports in <code>/srv/healtharchive/ops/search-eval</code></li> <li>Taxonomy + example list in this plan doc (append a short section under Phase 1)</li> <li>A short “baseline timing” note</li> </ul> <p><strong>Exit criteria:</strong> agreement on what “better” means and which snippet failures matter most.</p> <hr> <h2 id=phase-2-design-snippet-extraction-improvements-index-time-minimal-risk>Phase 2 — Design: snippet extraction improvements (index-time, minimal-risk)</h2> <p>Objective: define the smallest reliable extraction upgrade that improves snippets without destabilizing indexing.</p> <h3 id=21-design-principles>2.1 Design principles</h3> <ul> <li>Keep dependencies minimal (prefer improving BeautifulSoup heuristics over adding heavy libraries).</li> <li>Prefer deterministic extraction that behaves similarly across runs.</li> <li>Avoid query-time snippet generation (too expensive unless we store more text).</li> <li>Preserve provenance: snippets are derived metadata; do not alter WARC linkage or replay.</li> </ul> <h3 id=22-extraction-algorithm-upgrade-target-srcha_backendindexingtext_extractionpy>2.2 Extraction algorithm upgrade (target: <code>src/ha_backend/indexing/text_extraction.py</code>)</h3> <p>Define (before coding) the concrete strategy:</p> <p>1) Pre-clean DOM: - Remove <code>script</code>, <code>style</code>, <code>noscript</code>. - Remove semantic boilerplate tags: <code>nav</code>, <code>header</code>, <code>footer</code>, <code>aside</code>, <code>form</code>. - Remove ARIA boilerplate roles: navigation/banner/contentinfo/search.</p> <p>2) Choose a content root: - Prefer <code>&lt;main&gt;</code> or <code>[role=main]</code>. - Else prefer <code>&lt;article&gt;</code>. - Else score candidate containers (<code>article</code>, <code>section</code>, <code>div</code>) and pick the best: - text length (positive), - punctuation density (positive), - link density (negative), - boilerplate phrase match (negative).</p> <p>3) Extract candidate blocks: - Prefer paragraph-like blocks (<code>p</code>, headings + following paragraphs) rather than full-page text. - Preserve enough context for a meaningful snippet, but avoid dumping navigation lists.</p> <p>4) Snippet selection: - Choose the first “good” block meeting criteria; fall back to next best; final fallback to current behavior. - Ensure the snippet does not start with known boilerplate phrases. - Keep stable max length (e.g., ~280 chars) and clean whitespace.</p> <h3 id=23-archived-detection-decision-commit-to-recommendation>2.3 Archived detection decision (commit to recommendation)</h3> <p>Implement <code>Snapshot.is_archived</code> (Phase 3 will cover details). Snippet extraction should not need to keep archived banner text at the top in order to support ranking.</p> <h3 id=24-fts-vector-input-decision-commit-to-recommendation>2.4 FTS vector input decision (commit to recommendation)</h3> <p>Feed ~4KB of cleaned main content text into the search vector computation.</p> <p><strong>Deliverables:</strong></p> <ul> <li>A written extraction spec (heuristics + thresholds + bilingual boilerplate phrase list)</li> <li>A written archived detection spec (signals + conservatism rules)</li> <li>A written FTS text input spec (where content comes from; how it is truncated)</li> </ul> <p><strong>Exit criteria:</strong> we can predict how the changes address the Phase‑1 failures.</p> <hr> <h2 id=phase-3-implement-test-snippet-extraction-improvements-archived-flag>Phase 3 — Implement + test: snippet extraction improvements + archived flag</h2> <p>Objective: implement extraction changes safely with strong tests and a refresh/backfill path.</p> <h3 id=31-implement-extraction-changes-code>3.1 Implement extraction changes (code)</h3> <p>Files likely involved:</p> <ul> <li><code>src/ha_backend/indexing/text_extraction.py</code></li> <li><code>src/ha_backend/indexing/pipeline.py</code></li> <li><code>src/ha_backend/cli.py</code> (ensure refresh path stays aligned)</li> </ul> <p>Key requirements:</p> <ul> <li>Indexing and <code>refresh-snapshot-metadata</code> must share the same logic path (avoid drift).</li> <li>Snippet quality improves per taxonomy without breaking language detection.</li> <li>Content selection must degrade gracefully for malformed HTML.</li> </ul> <h3 id=32-add-snapshotis_archived-schema-model-extraction>3.2 Add <code>Snapshot.is_archived</code> (schema + model + extraction)</h3> <p>1) Add Alembic migration adding <code>snapshots.is_archived</code> (nullable boolean). 2) Update <code>src/ha_backend/models.py</code> <code>Snapshot</code> model. 3) Compute <code>is_archived</code> at indexing time based on conservative signals: - title prefix patterns (e.g., <code>Archived...</code>), - known bilingual banner phrases in extracted body text (not the UI snippet).</p> <p>Transition strategy:</p> <ul> <li>Until backfill is complete, ranking should treat <code>NULL</code> as “unknown” and fall back to existing title/snippet heuristics (so we don’t remove archived penalty accidentally).</li> </ul> <h3 id=33-update-fts-vector-input-postgres>3.3 Update FTS vector input (Postgres)</h3> <p>Ensure FTS vectors include:</p> <ul> <li>Title (high weight),</li> <li>Cleaned main content (medium weight; truncated to 4KB),</li> <li>URL (low weight),</li> </ul> <p>while the UI snippet remains short.</p> <p>Plan for backfill:</p> <ul> <li><code>ha-backend backfill-search-vector --force</code> off-peak, with progress logging.</li> </ul> <h3 id=34-tests-focused-regression>3.4 Tests (focused + regression)</h3> <p>Add unit tests for extraction using representative HTML fixtures.</p> <p>Assertions should cover:</p> <ul> <li>Boilerplate pruning removes nav/header/footer style text.</li> <li>Content-root selection works when <code>&lt;main&gt;</code> is missing.</li> <li>Snippets are stable, non-empty, and not dominated by boilerplate.</li> <li>Archived detection is conservative and bilingual-aware.</li> </ul> <p>Extend API-level tests to ensure:</p> <ul> <li>Search results include improved snippet text for seeded examples.</li> <li>Archived penalty behavior remains present (via is_archived or heuristic fallback).</li> </ul> <p><strong>Deliverables:</strong></p> <ul> <li>Extraction improvements implemented + tests passing (<code>make check</code>)</li> <li>Migration applied cleanly in dev/test environments</li> <li>Documented refresh/backfill procedure (Phase 7 will finalize canonical docs)</li> </ul> <p><strong>Exit criteria:</strong> local tests pass; extraction is measurably better on the Phase‑1 examples in local/staging.</p> <hr> <h2 id=phase-4-design-ranking-v3-targeted-explainable-reversible>Phase 4 — Design: ranking v3 (targeted, explainable, reversible)</h2> <p>Objective: define a small set of ranking changes that improve golden queries without regressions.</p> <h3 id=41-use-evidence-not-vibes>4.1 Use evidence (not vibes)</h3> <p>From baseline v1/v2 captures:</p> <ul> <li>Identify where v2 still fails (deep pages outranking hubs, archived pages surfacing too high, etc.).</li> <li>Identify whether snippet/vector improvements change recall in ways that may require coefficient retuning.</li> </ul> <h3 id=42-define-v3-changes-keep-it-small>4.2 Define v3 changes (keep it small)</h3> <p>Candidate levers (already present in the codebase in some form):</p> <ul> <li>Retune query-mode thresholds (<code>broad</code> / <code>mixed</code> / <code>specific</code>) for better blending.</li> <li>Retune coefficients in <code>src/ha_backend/search_ranking.py</code>.</li> <li>Penalties:</li> <li>querystring penalty and tracking penalty (possibly stronger for broad queries),</li> <li>depth penalty tuning (especially for <code>view=pages</code> grouping keys).</li> <li>Boosts:</li> <li>title token match boost,</li> <li>authority/hubness/pagerank blending when <code>page_signals</code> exists.</li> <li>Archived penalty:</li> <li>prefer <code>Snapshot.is_archived</code> when available and non-NULL (cheaper and more stable than snippet heuristics).</li> </ul> <h3 id=43-ensure-v3-is-explainable-via-admin-debug-output>4.3 Ensure v3 is explainable via admin debug output</h3> <p><code>/api/admin/search-debug</code> must:</p> <ul> <li>accept <code>ranking=v3</code>,</li> <li>show the same score breakdown components,</li> <li>remain stable enough for operators to reason about changes.</li> </ul> <p><strong>Deliverables:</strong></p> <ul> <li>A v3 scoring spec: formula components, coefficient table, and per-query-mode blends</li> <li>A “v3 target fixes” list mapped to golden queries</li> </ul> <p><strong>Exit criteria:</strong> v3 spec is narrow, measurable, and reversible.</p> <hr> <h2 id=phase-5-implement-test-ranking-v3-tooling-updates>Phase 5 — Implement + test: ranking v3 + tooling updates</h2> <p>Objective: add v3 without breaking clients; extend tooling to capture/diff v3.</p> <h3 id=51-introduce-v3-everywhere-it-must-exist>5.1 Introduce <code>v3</code> everywhere it must exist</h3> <p>Backend surfaces:</p> <ul> <li>Ranking config + parsing:</li> <li><code>src/ha_backend/search_ranking.py</code></li> <li>Query param validation:</li> <li><code>src/ha_backend/api/routes_public.py</code> (<code>/api/search</code>)</li> <li><code>src/ha_backend/api/routes_admin.py</code> (<code>/api/admin/search-debug</code>)</li> </ul> <p>Requirements:</p> <ul> <li>v1 and v2 behavior remains unchanged.</li> <li>v3 is opt-in via <code>ranking=v3</code> until Phase 7.</li> </ul> <h3 id=52-implement-v3-scoring-logic>5.2 Implement v3 scoring logic</h3> <p>Key requirements:</p> <ul> <li>Works on Postgres (prod) and SQLite (tests/dev).</li> <li>Avoids expensive operations unless strictly necessary.</li> <li>Uses <code>Snapshot.is_archived</code> when present and non-NULL; falls back otherwise.</li> </ul> <h3 id=53-update-evaluation-scripts>5.3 Update evaluation scripts</h3> <p>Update scripts to allow capturing v3:</p> <ul> <li><code>scripts/search-eval-capture.sh</code> should accept <code>--ranking v3</code>.</li> <li><code>scripts/search-eval-run.sh</code> should:</li> <li>support v2 vs v3 comparisons, or</li> <li>support a 3-way capture mode (v1/v2/v3) if useful.</li> </ul> <h3 id=54-extend-tests>5.4 Extend tests</h3> <p>Add test fixtures that demonstrate v2 vs v3 differences aligned to the v3 spec.</p> <p>Also extend admin search debug tests to validate:</p> <ul> <li><code>ranking=v3</code> is accepted,</li> <li>score breakdown fields remain present and coherent.</li> </ul> <p><strong>Deliverables:</strong></p> <ul> <li>v3 implemented and test-covered</li> <li>scripts can capture/diff v3 results</li> </ul> <p><strong>Exit criteria:</strong> v3 is usable via <code>ranking=v3</code>; tests pass.</p> <hr> <h2 id=phase-6-evaluation-loop-golden-queries-coefficient-tuning>Phase 6 — Evaluation loop (golden queries) + coefficient tuning</h2> <p>Objective: iterate until v3 reliably improves curated queries without obvious regressions.</p> <h3 id=61-run-repeated-captures-v2-vs-v3>6.1 Run repeated captures (v2 vs v3)</h3> <p>Capture matrix (minimum):</p> <ul> <li><code>view=pages</code> + <code>sort=relevance</code> (primary)</li> <li><code>view=snapshots</code> + <code>sort=relevance</code> (debugging)</li> </ul> <p>Store artifacts under:</p> <ul> <li><code>/srv/healtharchive/ops/search-eval</code></li> </ul> <p>For each iteration:</p> <ul> <li>Keep the diff report.</li> <li>Add a short note describing:</li> <li>which queries improved,</li> <li>which regressed,</li> <li>what coefficient/heuristic change was made.</li> </ul> <h3 id=62-update-golden-expectations-carefully>6.2 Update golden expectations carefully</h3> <p>Update <code>docs/operations/search-golden-queries.md</code> only when:</p> <ul> <li>archive coverage legitimately changed (new sources/pages),</li> <li>or expectations were incorrect/outdated.</li> </ul> <p>Do not “move goalposts” to hide ranking regressions.</p> <h3 id=63-performance-sanity-checks>6.3 Performance sanity checks</h3> <p>Ensure v3 does not meaningfully regress production query times.</p> <p>If it does:</p> <ul> <li>simplify heuristics,</li> <li>ensure expensive joins happen only when needed,</li> <li>treat index changes as an explicit subtask (avoid scope creep).</li> </ul> <p><strong>Deliverables:</strong></p> <ul> <li>A short v3 evaluation report section in this plan:</li> <li>what improved,</li> <li>what regressed (if anything),</li> <li>final coefficients and rationale.</li> </ul> <p><strong>Exit criteria:</strong> v3 is convincingly better on golden queries and not meaningfully slower.</p> <hr> <h2 id=phase-7-production-rollout-reversible-like-v2-canonical-docs-updates>Phase 7 — Production rollout (reversible like v2) + canonical docs updates</h2> <p>Objective: ship v3 safely with clear rollback and updated canonical docs.</p> <h3 id=71-rollout-strategy-single-vps>7.1 Rollout strategy (single VPS)</h3> <p>1) Deploy code with v3 available, keep default at v2. 2) Run production eval with <code>ranking=v3</code> explicitly (store capture artifacts). 3) Flip default: - set <code>HA_SEARCH_RANKING_VERSION=v3</code>, - restart API process.</p> <h3 id=72-data-maintenance-tasks-if-required-by-earlier-phases>7.2 Data maintenance tasks (if required by earlier phases)</h3> <p>Depending on what changed:</p> <ul> <li>If search vector inputs changed:</li> <li>run <code>ha-backend backfill-search-vector --force</code> off-peak.</li> <li>If snippet/title extraction changed materially:</li> <li>run <code>ha-backend refresh-snapshot-metadata --job-id ...</code> for recent/high-impact jobs first.</li> </ul> <h3 id=73-update-canonical-docs-post-implementation>7.3 Update canonical docs (post-implementation)</h3> <ul> <li><code>docs/deployment/search-rollout.md</code>:</li> <li>add v3 rollout + rollback steps,</li> <li>keep it current and reversible.</li> <li><code>docs/operations/search-quality.md</code>:</li> <li>ensure commands mention v3 where relevant.</li> <li><code>docs/architecture.md</code>:</li> <li>reflect v3 existence and any new derived fields (e.g., <code>is_archived</code>).</li> </ul> <h3 id=74-rollback-plan>7.4 Rollback plan</h3> <p>If v3 looks wrong in production:</p> <p>1) Set <code>HA_SEARCH_RANKING_VERSION=v2</code> (or <code>v1</code> if needed). 2) Restart API.</p> <p>Keep <code>ranking=v3</code> available for investigation even after rollback.</p> <h3 id=75-close-out-the-plan>7.5 Close out the plan</h3> <p>When complete:</p> <ul> <li>Move this plan to <code>docs/roadmaps/implemented/</code> with a dated filename.</li> <li>Ensure the backlog item is removed/updated in <code>docs/roadmaps/roadmap.md</code>.</li> </ul> <p><strong>Deliverables:</strong></p> <ul> <li>v3 live (or a documented “no-go” with evidence)</li> <li>canonical docs updated</li> <li>this plan archived under <code>docs/roadmaps/implemented/</code></li> </ul> <p><strong>Exit criteria:</strong> production default is v3 and the golden-query eval is documented as having passed.</p> <hr> <h2 id=risk-register-pre-mortem>Risk register (pre-mortem)</h2> <ul> <li>Risk: snippet cleanup removes signals used for ranking (archived detection).</li> <li>Mitigation: store <code>Snapshot.is_archived</code>; keep heuristic fallback for NULL during transition.</li> <li>Risk: improved FTS input reshuffles ranking too much.</li> <li>Mitigation: stage changes behind v3; evaluate via captures + diffs.</li> <li>Risk: backfills are heavy on a single VPS.</li> <li>Mitigation: batch, off-peak, tmux; prioritize newest jobs first; document stop/resume points.</li> <li>Risk: bilingual content behaves poorly with stemming/tokenization.</li> <li>Mitigation: keep <code>TS_CONFIG='simple'</code>; include French smoke tests in golden queries.</li> <li>Risk: regressions hidden by updated expectations.</li> <li>Mitigation: treat <code>docs/operations/search-golden-queries.md</code> as a contract; update only when coverage changes.</li> </ul> <hr> <h2 id=phase-1-findings-to-be-filled-after-baseline>Phase 1 findings (to be filled after baseline)</h2> <p>Add:</p> <ul> <li>Baseline run IDs and where artifacts were stored.</li> <li>Snippet failure taxonomy summary.</li> <li>Top 10 “worst” snippet examples (URL → snippet).</li> <li>Any obvious v1 vs v2 relevance observations worth carrying into v3 design.</li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jerdaw/healtharchive-backend target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://twitter.com/healtharchive target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "navigation.expand", "navigation.indexes", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>