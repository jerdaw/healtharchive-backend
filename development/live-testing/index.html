<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://docs.healtharchive.ca/development/live-testing/ rel=canonical><link href=../../tutorials/debug-crawl/ rel=prev><link href=../../operations/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Local Development Workflow - HealthArchive</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Local Development Workflow - HealthArchive"><meta property=og:image content=https://docs.healtharchive.ca/assets/images/social/development/live-testing.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://docs.healtharchive.ca/development/live-testing/ property=og:url><meta property=twitter:card content=summary_large_image><meta property=twitter:title content="Local Development Workflow - HealthArchive"><meta property=twitter:image content=https://docs.healtharchive.ca/assets/images/social/development/live-testing.png></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#healtharchive-backend-live-testing-guide class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=HealthArchive class="md-header__button md-logo" aria-label=HealthArchive data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> HealthArchive </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Local Development Workflow </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jerdaw/healtharchive-backend title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> jerdaw/healtharchive-backend </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../quickstart/ class=md-tabs__link> Getting Started </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../tutorials/first-contribution/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../operations/ class=md-tabs__link> How-To Guides </a> </li> <li class=md-tabs__item> <a href=../../api/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../documentation-guidelines/ class=md-tabs__link> Explanation </a> </li> <li class=md-tabs__item> <a href=../../roadmaps/ class=md-tabs__link> Planning & Roadmaps </a> </li> <li class=md-tabs__item> <a href=../../project/ class=md-tabs__link> About </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=HealthArchive class="md-nav__button md-logo" aria-label=HealthArchive data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> HealthArchive </label> <div class=md-nav__source> <a href=https://github.com/jerdaw/healtharchive-backend title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> jerdaw/healtharchive-backend </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../quickstart/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class=md-nav__item> <a href=../../project/ class=md-nav__link> <span class=md-ellipsis> Project Overview </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> Choose Your Path </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Choose Your Path </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/operator-responsibilities/ class=md-nav__link> <span class=md-ellipsis> I'm an Operator </span> </a> </li> <li class=md-nav__item> <a href=../dev-environment-setup/ class=md-nav__link> <span class=md-ellipsis> I'm a Developer </span> </a> </li> <li class=md-nav__item> <a href=../../api-consumer-guide/ class=md-nav__link> <span class=md-ellipsis> I'm an API Consumer </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/first-contribution/ class=md-nav__link> <span class=md-ellipsis> Your First Contribution </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/architecture-walkthrough/ class=md-nav__link> <span class=md-ellipsis> Architecture Walkthrough </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/debug-crawl/ class=md-nav__link> <span class=md-ellipsis> Debugging a Failed Crawl </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Local Development Workflow </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Local Development Workflow </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0-onetime-setup class=md-nav__link> <span class=md-ellipsis> 0. One‑time setup </span> </a> <nav class=md-nav aria-label="0. One‑time setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#01-create-a-virtualenv-and-install-the-backend class=md-nav__link> <span class=md-ellipsis> 0.1 Create a virtualenv and install the backend </span> </a> </li> <li class=md-nav__item> <a href=#02-configure-environment-variables class=md-nav__link> <span class=md-ellipsis> 0.2 Configure environment variables </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#1-smallest-checks-no-docker-no-jobs class=md-nav__link> <span class=md-ellipsis> 1. Smallest checks (no Docker, no jobs) </span> </a> <nav class=md-nav aria-label="1. Smallest checks (no Docker, no jobs)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-run-the-test-suite class=md-nav__link> <span class=md-ellipsis> 1.1 Run the test suite </span> </a> </li> <li class=md-nav__item> <a href=#12-check-db-connectivity class=md-nav__link> <span class=md-ellipsis> 1.2 Check DB connectivity </span> </a> </li> <li class=md-nav__item> <a href=#13-check-environment-archive-root class=md-nav__link> <span class=md-ellipsis> 1.3 Check environment / archive root </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-apionly-live-smoke-tests-no-archive_tool-no-jobs class=md-nav__link> <span class=md-ellipsis> 2. API‑only live smoke tests (no archive_tool, no jobs) </span> </a> <nav class=md-nav aria-label="2. API‑only live smoke tests (no archive_tool, no jobs)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-start-the-api class=md-nav__link> <span class=md-ellipsis> 2.1 Start the API </span> </a> </li> <li class=md-nav__item> <a href=#22-hit-public-endpoints class=md-nav__link> <span class=md-ellipsis> 2.2 Hit public endpoints </span> </a> </li> <li class=md-nav__item> <a href=#23-admin-endpoints class=md-nav__link> <span class=md-ellipsis> 2.3 Admin endpoints </span> </a> </li> <li class=md-nav__item> <a href=#24-admin-access-patterns-local-vs-stagingprod class=md-nav__link> <span class=md-ellipsis> 2.4 Admin access patterns (local vs staging/prod) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-minimal-archive_tool-integration-sanity-only class=md-nav__link> <span class=md-ellipsis> 3. Minimal archive_tool integration (sanity only) </span> </a> <nav class=md-nav aria-label="3. Minimal archive_tool integration (sanity only)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-verify-archive_tool-docker class=md-nav__link> <span class=md-ellipsis> 3.1 Verify archive_tool &amp; Docker </span> </a> </li> <li class=md-nav__item> <a href=#32-optional-direct-archive_tool-dry-run class=md-nav__link> <span class=md-ellipsis> 3.2 Optional: direct archive_tool dry run </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-small-dbbacked-job-pipeline-in-a-dev-sandbox class=md-nav__link> <span class=md-ellipsis> 4. Small DB‑backed job pipeline in a dev sandbox </span> </a> <nav class=md-nav aria-label="4. Small DB‑backed job pipeline in a dev sandbox"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#41-seed-sources class=md-nav__link> <span class=md-ellipsis> 4.1 Seed sources </span> </a> </li> <li class=md-nav__item> <a href=#42-create-a-job class=md-nav__link> <span class=md-ellipsis> 4.2 Create a job </span> </a> </li> <li class=md-nav__item> <a href=#43-run-the-crawl-once class=md-nav__link> <span class=md-ellipsis> 4.3 Run the crawl once </span> </a> </li> <li class=md-nav__item> <a href=#44-index-the-job-best-effort class=md-nav__link> <span class=md-ellipsis> 4.4 Index the job (best effort) </span> </a> </li> <li class=md-nav__item> <a href=#45-verify-via-cli-and-api class=md-nav__link> <span class=md-ellipsis> 4.5 Verify via CLI and API </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-worker-loop-tests-background-processing class=md-nav__link> <span class=md-ellipsis> 5. Worker loop tests (background processing) </span> </a> <nav class=md-nav aria-label="5. Worker loop tests (background processing)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-queue-a-couple-of-jobs class=md-nav__link> <span class=md-ellipsis> 5.1 Queue a couple of jobs </span> </a> </li> <li class=md-nav__item> <a href=#52-run-worker-in-singlecycle-mode class=md-nav__link> <span class=md-ellipsis> 5.2 Run worker in single‑cycle mode </span> </a> </li> <li class=md-nav__item> <a href=#53-worker-loop-with-a-harmless-tool-command-optional class=md-nav__link> <span class=md-ellipsis> 5.3 Worker loop with a harmless tool command (optional) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-raw-snapshot-viewer-tests class=md-nav__link> <span class=md-ellipsis> 6. Raw snapshot viewer tests </span> </a> <nav class=md-nav aria-label="6. Raw snapshot viewer tests"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#61-happypath-viewer-using-a-synthetic-warc class=md-nav__link> <span class=md-ellipsis> 6.1 Happy‑path viewer using a synthetic WARC </span> </a> </li> <li class=md-nav__item> <a href=#62-error-path-when-warcs-are-missing class=md-nav__link> <span class=md-ellipsis> 6.2 Error path when WARCs are missing </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7-real-warc-indexing-advanced class=md-nav__link> <span class=md-ellipsis> 7. Real WARC indexing (advanced) </span> </a> <nav class=md-nav aria-label="7. Real WARC indexing (advanced)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#71-fix-permissions-on-the-temp-dir-if-needed class=md-nav__link> <span class=md-ellipsis> 7.1 Fix permissions on the temp dir (if needed) </span> </a> </li> <li class=md-nav__item> <a href=#72-create-a-db-job-pointing-at-this-output_dir class=md-nav__link> <span class=md-ellipsis> 7.2 Create a DB job pointing at this output_dir </span> </a> </li> <li class=md-nav__item> <a href=#73-index-the-job-and-verify-via-api class=md-nav__link> <span class=md-ellipsis> 7.3 Index the job and verify via API </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8-admin-retry-and-cleanup-flows class=md-nav__link> <span class=md-ellipsis> 8. Admin, retry, and cleanup flows </span> </a> <nav class=md-nav aria-label="8. Admin, retry, and cleanup flows"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#81-retry-jobs class=md-nav__link> <span class=md-ellipsis> 8.1 Retry jobs </span> </a> </li> <li class=md-nav__item> <a href=#82-cleanup-temp-dirs-and-state class=md-nav__link> <span class=md-ellipsis> 8.2 Cleanup temp dirs and state </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9-metrics-and-observability class=md-nav__link> <span class=md-ellipsis> 9. Metrics and observability </span> </a> </li> <li class=md-nav__item> <a href=#10-scaling-up-to-more-realistic-scenarios class=md-nav__link> <span class=md-ellipsis> 10. Scaling up to more realistic scenarios </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> How-To Guides </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> How-To Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1> <div class="md-nav__link md-nav__container"> <a href=../../operations/ class="md-nav__link "> <span class=md-ellipsis> Operations </span> </a> <label class="md-nav__link " for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_2> <label class=md-nav__link for=__nav_4_1_2 id=__nav_4_1_2_label tabindex=0> <span class=md-ellipsis> Core Playbooks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_2> <span class="md-nav__icon md-icon"></span> Core Playbooks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/operator-responsibilities/ class=md-nav__link> <span class=md-ellipsis> I'm an Operator </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/deploy-and-verify/ class=md-nav__link> <span class=md-ellipsis> Deploy & Verify </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/incident-response/ class=md-nav__link> <span class=md-ellipsis> Incident Response </span> </a> </li> <li class=md-nav__item> <a href=../../operations/escalation-procedures/ class=md-nav__link> <span class=md-ellipsis> Escalation Procedures </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_3> <label class=md-nav__link for=__nav_4_1_3 id=__nav_4_1_3_label tabindex=0> <span class=md-ellipsis> Observability </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_3> <span class="md-nav__icon md-icon"></span> Observability </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/check-logs-api-worker-access.md class=md-nav__link> <span class=md-ellipsis> Check Logs </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/verify-search-index-coverage.md class=md-nav__link> <span class=md-ellipsis> Verify Search Index </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/check-warc-tiering-status.md class=md-nav__link> <span class=md-ellipsis> Monitor WARC Tiering </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/check-disk-space.md class=md-nav__link> <span class=md-ellipsis> Check Disk Space </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/check-healthchecks-io-status.md class=md-nav__link> <span class=md-ellipsis> Check Healthchecks </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/check-tailscale-connectivity.md class=md-nav__link> <span class=md-ellipsis> Check Tailscale </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/review-prometheus-metrics.md class=md-nav__link> <span class=md-ellipsis> Review Metrics </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_4> <label class=md-nav__link for=__nav_4_1_4 id=__nav_4_1_4_label tabindex=0> <span class=md-ellipsis> Crawls & Archives </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_4> <span class="md-nav__icon md-icon"></span> Crawls & Archives </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/validate-export-integrity.md class=md-nav__link> <span class=md-ellipsis> Validate Export Integrity </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/reconcile-replay-collection.md class=md-nav__link> <span class=md-ellipsis> Reconcile Replay Collection </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/reindex-job-warcs.md class=md-nav__link> <span class=md-ellipsis> Reindex Job WARCs </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/trigger-manual-crawl.md class=md-nav__link> <span class=md-ellipsis> Trigger Manual Crawl </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_5> <label class=md-nav__link for=__nav_4_1_5 id=__nav_4_1_5_label tabindex=0> <span class=md-ellipsis> Storage </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_5> <span class="md-nav__icon md-icon"></span> Storage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/check-tailnet-storage-quota.md class=md-nav__link> <span class=md-ellipsis> Check Storage Quotas </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/manage-warc-cleanup.md class=md-nav__link> <span class=md-ellipsis> Manage WARC Cleanup </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/verify-warc-tier-distribution.md class=md-nav__link> <span class=md-ellipsis> Verify WARC Tier Distribution </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_6> <label class=md-nav__link for=__nav_4_1_6 id=__nav_4_1_6_label tabindex=0> <span class=md-ellipsis> Validation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_6> <span class="md-nav__icon md-icon"></span> Validation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/restore-test/ class=md-nav__link> <span class=md-ellipsis> Restore Test </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/verify-coverage.md class=md-nav__link> <span class=md-ellipsis> Verify Coverage </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/dataset-release/ class=md-nav__link> <span class=md-ellipsis> Dataset Release </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/baseline-drift-check.md class=md-nav__link> <span class=md-ellipsis> Baseline Drift Check </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/verify-ops-automation.md class=md-nav__link> <span class=md-ellipsis> Verify Ops Automation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_1_7> <label class=md-nav__link for=__nav_4_1_7 id=__nav_4_1_7_label tabindex=0> <span class=md-ellipsis> External </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_7_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_7> <span class="md-nav__icon md-icon"></span> External </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/playbooks/adoption-signals/ class=md-nav__link> <span class=md-ellipsis> Adoption Signals </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/write-changelog-entry.md class=md-nav__link> <span class=md-ellipsis> Write Changelog Entry </span> </a> </li> <li class=md-nav__item> <a href=../../operations/playbooks/handle-user-issue-report.md class=md-nav__link> <span class=md-ellipsis> Handle User Issue Report </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../operations/service-levels/ class=md-nav__link> <span class=md-ellipsis> Service Levels </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../dev-environment-setup/ class=md-nav__link> <span class=md-ellipsis> I'm a Developer </span> </a> </li> <li class=md-nav__item> <a href=../testing-guidelines/ class=md-nav__link> <span class=md-ellipsis> Run Tests </span> </a> </li> <li class=md-nav__item> <a href=../playbooks/database-migrations.md class=md-nav__link> <span class=md-ellipsis> Making Database Changes </span> </a> </li> <li class=md-nav__item> <a href=../playbooks/add-cli-command.md class=md-nav__link> <span class=md-ellipsis> Adding New CLI Commands </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4_3> <div class="md-nav__link md-nav__container"> <a href=../../deployment/systemd/ class="md-nav__link "> <span class=md-ellipsis> Deployment </span> </a> <label class="md-nav__link " for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Deployment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../deployment/production-single-vps/ class=md-nav__link> <span class=md-ellipsis> Production Setup </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/environments-and-configuration/ class=md-nav__link> <span class=md-ellipsis> Configure Environments </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/hosting-and-live-server-to-dos/ class=md-nav__link> <span class=md-ellipsis> Deploy to Production </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/production-rollout-checklist/ class=md-nav__link> <span class=md-ellipsis> Rollout Checklist </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/replay-service-pywb/ class=md-nav__link> <span class=md-ellipsis> Setup Replay Service </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/search-rollout/ class=md-nav__link> <span class=md-ellipsis> Enable Search V2 </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/pages-table-rollout/ class=md-nav__link> <span class=md-ellipsis> Setup Pages Table </span> </a> </li> <li class=md-nav__item> <a href=../../deployment/disaster-recovery/ class=md-nav__link> <span class=md-ellipsis> Disaster Recovery </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../../datasets-external/ class="md-nav__link "> <span class=md-ellipsis> Reference </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/ class=md-nav__link> <span class=md-ellipsis> API Documentation </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/ class=md-nav__link> <span class=md-ellipsis> Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../reference/data-model/ class=md-nav__link> <span class=md-ellipsis> Data Model </span> </a> </li> <li class=md-nav__item> <a href=../../reference/archive-tool/ class=md-nav__link> <span class=md-ellipsis> Archive Tool </span> </a> </li> <li class=md-nav__item> <a href=../../reference/cli-commands/ class=md-nav__link> <span class=md-ellipsis> CLI Commands </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_6> <div class="md-nav__link md-nav__container"> <a href=../../deployment/systemd/ class="md-nav__link "> <span class=md-ellipsis> Configuration </span> </a> <label class="md-nav__link " for=__nav_5_6 id=__nav_5_6_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../deployment/environments-and-configuration/ class=md-nav__link> <span class=md-ellipsis> Configure Environments </span> </a> </li> <li class=md-nav__item> <a href=../../operations/thresholds-and-tuning/ class=md-nav__link> <span class=md-ellipsis> Thresholds & Tuning </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_8> <div class="md-nav__link md-nav__container"> <a href=../../frontend-external/ class="md-nav__link "> <span class=md-ellipsis> Frontend </span> </a> <label class="md-nav__link " for=__nav_5_8 id=__nav_5_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Frontend </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../frontend-external/i18n/ class=md-nav__link> <span class=md-ellipsis> I18n Guide </span> </a> </li> <li class=md-nav__item> <a href=../../frontend-external/implementation-guide/ class=md-nav__link> <span class=md-ellipsis> Implementation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <div class="md-nav__link md-nav__container"> <a href=../../decisions/ class="md-nav__link "> <span class=md-ellipsis> Explanation </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Explanation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../documentation-guidelines/ class=md-nav__link> <span class=md-ellipsis> Documentation Guidelines </span> </a> </li> <li class=md-nav__item> <a href=../../documentation-process-audit/ class=md-nav__link> <span class=md-ellipsis> Documentation Audit </span> </a> </li> <li class=md-nav__item> <a href=../../operations/ops-cadence-checklist/ class=md-nav__link> <span class=md-ellipsis> Ops Cadence </span> </a> </li> <li class=md-nav__item> <a href=../../operations/monitoring-and-ci-checklist/ class=md-nav__link> <span class=md-ellipsis> Monitoring Checklist </span> </a> </li> <li class=md-nav__item> <a href=../../operations/risk-register/ class=md-nav__link> <span class=md-ellipsis> Risk Register </span> </a> </li> <li class=md-nav__item> <a href=../../operations/baseline-drift/ class=md-nav__link> <span class=md-ellipsis> Baseline Drift </span> </a> </li> <li class=md-nav__item> <a href=../../operations/data-handling-and-retention.md class=md-nav__link> <span class=md-ellipsis> Data Handling </span> </a> </li> <li class=md-nav__item> <a href=../../operations/automation.md class=md-nav__link> <span class=md-ellipsis> Automation </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_10> <div class="md-nav__link md-nav__container"> <a href=../../operations/incidents/ class="md-nav__link "> <span class=md-ellipsis> Incident Management </span> </a> <label class="md-nav__link " for=__nav_6_10 id=__nav_6_10_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_10_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10> <span class="md-nav__icon md-icon"></span> Incident Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/incidents/severity/ class=md-nav__link> <span class=md-ellipsis> Severity Guide </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_10_3> <label class=md-nav__link for=__nav_6_10_3 id=__nav_6_10_3_label tabindex=0> <span class=md-ellipsis> Post-Mortems </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_6_10_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10_3> <span class="md-nav__icon md-icon"></span> Post-Mortems </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operations/incidents/2026-01-08-storage-hotpath-sshfs-stale-mount/ class=md-nav__link> <span class=md-ellipsis> Storage Hotpath (2026-01-08) </span> </a> </li> <li class=md-nav__item> <a href=../../operations/incidents/2026-01-09-annual-crawl-hc-job-stalled/ class=md-nav__link> <span class=md-ellipsis> Annual Crawl Stalled (2026-01-09) </span> </a> </li> <li class=md-nav__item> <a href=../../operations/incidents/2026-01-09-annual-crawl-phac-output-dir-permission-denied/ class=md-nav__link> <span class=md-ellipsis> PHAC Permission Denied (2026-01-09) </span> </a> </li> <li class=md-nav__item> <a href=../../operations/incidents/2026-01-16-replay-smoke-503-and-warctieringfailed/ class=md-nav__link> <span class=md-ellipsis> Replay Smoke 503 (2026-01-16) </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <div class="md-nav__link md-nav__container"> <a href=../../roadmaps/ class="md-nav__link "> <span class=md-ellipsis> Planning & Roadmaps </span> </a> <label class="md-nav__link " for=__nav_7 id=__nav_7_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Planning & Roadmaps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roadmaps/roadmap/ class=md-nav__link> <span class=md-ellipsis> Future Roadmap </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap-process/ class=md-nav__link> <span class=md-ellipsis> Roadmap Process </span> </a> </li> <li class=md-nav__item> <a href=../../roadmaps/implemented/ class=md-nav__link> <span class=md-ellipsis> Implemented Plans </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <div class="md-nav__link md-nav__container"> <a href=../../_templates/ class="md-nav__link "> <span class=md-ellipsis> About </span> </a> <label class="md-nav__link " for=__nav_8 id=__nav_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> About </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../project/ class=md-nav__link> <span class=md-ellipsis> Project Overview </span> </a> </li> <li class=md-nav__item> <a href=../../CONTRIBUTING.md class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../../meta/documentation-health/ class=md-nav__link> <span class=md-ellipsis> Documentation Health </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=healtharchive-backend-live-testing-guide>HealthArchive Backend – Live Testing Guide</h1> <p>This document describes a practical, incremental way to live‑test the <code>healtharchive-backend</code> in a local development environment, starting with the smallest checks and working up to more realistic scenarios.</p> <p>It assumes you are working from the repo root and are comfortable with a terminal and Python tooling.</p> <hr> <h2 id=0-onetime-setup>0. One‑time setup</h2> <h3 id=01-create-a-virtualenv-and-install-the-backend>0.1 Create a virtualenv and install the backend</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>make<span class=w> </span>venv
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=c1># or (manual):</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=c1># python -m venv .venv</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=c1># source .venv/bin/activate</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1># pip install -e &quot;.[dev]&quot;</span>
</code></pre></div> <p>This provides:</p> <ul> <li><code>ha-backend</code> – backend CLI</li> <li><code>archive-tool</code> – crawler CLI implemented by the in-repo <code>archive_tool</code> package (uses Docker + Zimit)</li> </ul> <h3 id=02-configure-environment-variables>0.2 Configure environment variables</h3> <p>Use a local SQLite DB and archive root so you never touch production paths:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nb>export</span><span class=w> </span><span class=nv>HEALTHARCHIVE_DATABASE_URL</span><span class=o>=</span>sqlite:///<span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/.dev-healtharchive.db
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=nb>export</span><span class=w> </span><span class=nv>HEALTHARCHIVE_ARCHIVE_ROOT</span><span class=o>=</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/.dev-archive-root
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=nb>export</span><span class=w> </span><span class=nv>HEALTHARCHIVE_ADMIN_TOKEN</span><span class=o>=</span>localdev-admin<span class=w>  </span><span class=c1># optional but recommended</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=c1># Optional: set CORS origins if your frontend runs on a non-default host</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=c1># (defaults already include http://localhost:3000 and https://healtharchive.ca)</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=c1># export HEALTHARCHIVE_CORS_ORIGINS=http://localhost:3000</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=c1># Shortcut: copy the sample file and source it</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=c1># cp .env.example .env</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=c1># source .env</span>
</code></pre></div> <p>Run Alembic migrations once to create the schema:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>alembic<span class=w> </span>upgrade<span class=w> </span>head
</code></pre></div> <hr> <h2 id=1-smallest-checks-no-docker-no-jobs>1. Smallest checks (no Docker, no jobs)</h2> <p>Goal: prove the Python package and DB wiring work in isolation.</p> <h3 id=11-run-the-test-suite>1.1 Run the test suite</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>make<span class=w> </span>ci
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=c1># or (full suite):</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=c1># make check-full</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=c1># or (tests only):</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=c1># pytest -q</span>
</code></pre></div> <p>All tests should pass. (At time of writing, a 422 around <code>/api/admin/jobs/status-counts</code> was fixed so this now passes too.)</p> <h3 id=12-check-db-connectivity>1.2 Check DB connectivity</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>ha-backend<span class=w> </span>check-db
</code></pre></div> <p>You should see:</p> <ul> <li>The <code>HEALTHARCHIVE_DATABASE_URL</code> you set.</li> <li>“Database connection OK.”</li> </ul> <h3 id=13-check-environment-archive-root>1.3 Check environment / archive root</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>ha-backend<span class=w> </span>check-env
</code></pre></div> <p>Confirms:</p> <ul> <li><code>HEALTHARCHIVE_ARCHIVE_ROOT</code> exists and is writable.</li> <li>The configured <code>archive_tool</code> command is resolvable.</li> </ul> <hr> <h2 id=2-apionly-live-smoke-tests-no-archive_tool-no-jobs>2. API‑only live smoke tests (no archive_tool, no jobs)</h2> <p>Goal: run FastAPI + DB with an empty dataset.</p> <h3 id=21-start-the-api>2.1 Start the API</h3> <p>In one terminal (with <code>.venv</code> active and env vars set):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>uvicorn<span class=w> </span>ha_backend.api:app<span class=w> </span>--reload<span class=w> </span>--port<span class=w> </span><span class=m>8001</span>
</code></pre></div> <h3 id=22-hit-public-endpoints>2.2 Hit public endpoints</h3> <p>From another terminal:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>curl<span class=w> </span>http://localhost:8001/api/health
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>curl<span class=w> </span>http://localhost:8001/api/sources
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>curl<span class=w> </span><span class=s2>&quot;http://localhost:8001/api/search?q=test&quot;</span>
</code></pre></div> <p>Expect:</p> <ul> <li><code>/api/health</code> → <code>{"status":"ok", ... "db":"ok" ...}</code>.</li> <li><code>/api/sources</code> → <code>[]</code> (no data yet).</li> <li><code>/api/search</code> → empty results, but HTTP 200.</li> </ul> <h3 id=23-admin-endpoints>2.3 Admin endpoints</h3> <p>With <code>HEALTHARCHIVE_ADMIN_TOKEN</code> <strong>unset</strong> (local dev only):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>curl<span class=w> </span>http://localhost:8001/api/admin/jobs
</code></pre></div> <p>Admin routes are open (dev mode).</p> <p>With <code>HEALTHARCHIVE_ADMIN_TOKEN=localdev-admin</code> set when starting uvicorn:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer localdev-admin&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>  </span>http://localhost:8001/api/admin/jobs
</code></pre></div> <p>Confirms admin auth + simple bearer token protection.</p> <h3 id=24-admin-access-patterns-local-vs-stagingprod>2.4 Admin access patterns (local vs staging/prod)</h3> <p>In local development it is acceptable to either leave <code>HEALTHARCHIVE_ADMIN_TOKEN</code> unset (open admin endpoints) or to use a simple token like <code>localdev-admin</code> as shown above.</p> <p>In staging and production you should <strong>always</strong> set a strong, random admin token and treat it as a secret:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=nb>export</span><span class=w> </span><span class=nv>HEALTHARCHIVE_ADMIN_TOKEN</span><span class=o>=</span><span class=s2>&quot;prod-admin-token-from-secret-store&quot;</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>uvicorn<span class=w> </span>ha_backend.api:app<span class=w> </span>--host<span class=w> </span><span class=m>0</span>.0.0.0<span class=w> </span>--port<span class=w> </span><span class=m>8001</span>
</code></pre></div> <p>From a trusted machine you can then verify access:</p> <ul> <li>Without a token (should be forbidden when the env var is set):</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>curl<span class=w> </span>-i<span class=w> </span><span class=s2>&quot;https://api.healtharchive.ca/api/admin/jobs&quot;</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>curl<span class=w> </span>-i<span class=w> </span><span class=s2>&quot;https://api.healtharchive.ca/metrics&quot;</span>
</code></pre></div> <ul> <li>With the correct token:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>curl<span class=w> </span>-i<span class=w> </span><span class=se>\</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>  </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer </span><span class=nv>$HEALTHARCHIVE_ADMIN_TOKEN</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>  </span><span class=s2>&quot;https://api.healtharchive.ca/api/admin/jobs&quot;</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>curl<span class=w> </span>-i<span class=w> </span><span class=se>\</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=w>  </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer </span><span class=nv>$HEALTHARCHIVE_ADMIN_TOKEN</span><span class=s2>&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>  </span><span class=s2>&quot;https://api.healtharchive.ca/metrics&quot;</span>
</code></pre></div> <p>In staging/prod you should call these endpoints only from operator tooling or monitoring systems (Prometheus, etc.), not from the public frontend.</p> <hr> <h2 id=3-minimal-archive_tool-integration-sanity-only>3. Minimal archive_tool integration (sanity only)</h2> <p>Goal: prove Docker + <code>archive_tool</code> wiring work without committing to long crawls.</p> <h3 id=31-verify-archive_tool-docker>3.1 Verify archive_tool &amp; Docker</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>ha-backend<span class=w> </span>check-archive-tool
</code></pre></div> <p>This runs <code>archive-tool --help</code> via the configured command (by default <code>archive-tool</code>, which uses Docker).</p> <p>If this fails, fix Docker or PATH before proceeding.</p> <h3 id=32-optional-direct-archive_tool-dry-run>3.2 Optional: direct archive_tool dry run</h3> <p>From the repo root:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>archive-tool<span class=w> </span>--seeds<span class=w> </span>https://example.org<span class=w> </span>--name<span class=w> </span>example<span class=w> </span>--output-dir<span class=w> </span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/.dev-archive-root/dry-run<span class=w> </span>--dry-run
</code></pre></div> <p>This is not required for backend work, but is a quick sanity check that the integrated crawler CLI works directly and that your configuration (seeds, output directory, workers, monitoring flags) is valid without actually starting Docker containers.</p> <hr> <h2 id=4-small-dbbacked-job-pipeline-in-a-dev-sandbox>4. Small DB‑backed job pipeline in a dev sandbox</h2> <p>Goal: run a single small job end‑to‑end (create → run → index) using the same flows the worker will use, with the important caveat that the current Zimit image may not leave WARCs accessible (see notes below).</p> <h3 id=41-seed-sources>4.1 Seed sources</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>ha-backend<span class=w> </span>seed-sources
</code></pre></div> <p>This inserts baseline <code>Source</code> rows (e.g., <code>hc</code>, <code>phac</code>).</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>ha-backend<span class=w> </span>list-jobs
</code></pre></div> <p>Should still show no <code>ArchiveJob</code> rows initially.</p> <h3 id=42-create-a-job>4.2 Create a job</h3> <p>Start with Health Canada:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>ha-backend<span class=w> </span>create-job<span class=w> </span>--source<span class=w> </span>hc
</code></pre></div> <p>Note the printed job ID (call it <code>JOB_ID</code>). At this point:</p> <ul> <li>A DB row exists with <code>status="queued"</code>.</li> <li>An <code>output_dir</code> path under <code>HEALTHARCHIVE_ARCHIVE_ROOT</code> is reserved.</li> </ul> <h3 id=43-run-the-crawl-once>4.3 Run the crawl once</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>ha-backend<span class=w> </span>run-db-job<span class=w> </span>--id<span class=w> </span>JOB_ID
</code></pre></div> <p>This:</p> <ul> <li>Loads the DB row.</li> <li>Constructs an <code>archive_tool</code> command.</li> <li>Runs Docker + Zimit.</li> </ul> <p>It can take a minute or more depending on seeds and limits. If it fails:</p> <ul> <li>Inspect <code>ha-backend show-job --id JOB_ID</code> for <code>crawler_exit_code</code>, <code>status</code>, and <code>output_dir</code>.</li> <li>Check logs under that <code>output_dir</code> with <code>ls</code> and <code>less</code>.</li> </ul> <blockquote> <p><strong>Note:</strong> With the current Zimit image and defaults, small runs may still end with <code>FAILED_NO_WARCS</code> because no accessible WARCs are left under <code>/output/.tmp*</code>. This is a limitation of the current crawler image and does not block backend/API development (see section 6 for a controlled WARC test).</p> </blockquote> <h3 id=44-index-the-job-best-effort>4.4 Index the job (best effort)</h3> <p>Once a job has <code>status="completed"</code>, you can attempt:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>ha-backend<span class=w> </span>index-job<span class=w> </span>--id<span class=w> </span>JOB_ID
</code></pre></div> <p>This:</p> <ul> <li>Runs WARC discovery based on <code>job.output_dir</code>.</li> <li>Streams WARCs into <code>Snapshot</code> rows.</li> <li>Updates <code>warc_file_count</code> and <code>indexed_page_count</code>.</li> </ul> <p>If no WARCs are discovered, the job is marked <code>index_failed</code>. This is expected when the crawler leaves no accessible WARCs.</p> <h3 id=45-verify-via-cli-and-api>4.5 Verify via CLI and API</h3> <p>CLI:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>ha-backend<span class=w> </span>show-job<span class=w> </span>--id<span class=w> </span>JOB_ID
</code></pre></div> <p>Look for:</p> <ul> <li><code>status="indexed"</code> and <code>indexed_page_count &gt; 0</code> (ideal case), or</li> <li><code>status="index_failed"</code> if no WARCs were found.</li> </ul> <p>API (with uvicorn running):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>curl<span class=w> </span>http://localhost:8001/api/sources
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>curl<span class=w> </span><span class=s2>&quot;http://localhost:8001/api/search?q=health&amp;source=hc&quot;</span>
</code></pre></div> <p>If indexing succeeded, these will reflect real crawl data. In practice, for development we often use synthetic snapshots instead (see 6.2).</p> <hr> <h2 id=5-worker-loop-tests-background-processing>5. Worker loop tests (background processing)</h2> <p>Goal: test the long‑running worker process that automates job execution.</p> <h3 id=51-queue-a-couple-of-jobs>5.1 Queue a couple of jobs</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>ha-backend<span class=w> </span>create-job<span class=w> </span>--source<span class=w> </span>hc
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>ha-backend<span class=w> </span>create-job<span class=w> </span>--source<span class=w> </span>phac
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>ha-backend<span class=w> </span>list-jobs
</code></pre></div> <p>You should see the new jobs in <code>status="queued"</code>.</p> <h3 id=52-run-worker-in-singlecycle-mode>5.2 Run worker in single‑cycle mode</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>ha-backend<span class=w> </span>start-worker<span class=w> </span>--once
</code></pre></div> <p>The worker:</p> <ul> <li>Picks the oldest <code>queued</code>/<code>retryable</code> job.</li> <li>Runs <code>run_persistent_job(job_id)</code> (archive_tool).</li> <li>Immediately runs <code>index_job(job_id)</code>.</li> <li>Exits after one iteration.</li> </ul> <p>Check transitions:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>ha-backend<span class=w> </span>list-jobs
</code></pre></div> <p>Statuses should move (e.g., <code>queued</code> → <code>completed</code>/<code>index_failed</code>).</p> <h3 id=53-worker-loop-with-a-harmless-tool-command-optional>5.3 Worker loop with a harmless tool command (optional)</h3> <p>For pure orchestration tests, point <code>archive_tool</code> at <code>echo</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=nb>export</span><span class=w> </span><span class=nv>HEALTHARCHIVE_TOOL_CMD</span><span class=o>=</span><span class=nb>echo</span>
</code></pre></div> <p>Then:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>ha-backend<span class=w> </span>create-job<span class=w> </span>--source<span class=w> </span>hc
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>ha-backend<span class=w> </span>start-worker<span class=w> </span>--once
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>ha-backend<span class=w> </span>list-jobs
</code></pre></div> <p>You will see jobs flip from <code>queued</code> to <code>completed</code> (crawl RC 0) and then to <code>index_failed</code> (no WARCs), verifying the worker loop and status updates without touching Docker.</p> <hr> <h2 id=6-raw-snapshot-viewer-tests>6. Raw snapshot viewer tests</h2> <p>Goal: confirm WARC → HTML replay is functioning.</p> <p>There are two complementary approaches:</p> <h3 id=61-happypath-viewer-using-a-synthetic-warc>6.1 Happy‑path viewer using a synthetic WARC</h3> <p>You can create a tiny WARC file and a corresponding <code>Snapshot</code> in the DB:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>python<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt; &#39;PY&#39;</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=s>from datetime import datetime, timezone</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=s>from pathlib import Path</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=s>from io import BytesIO</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=s>from warcio.warcwriter import WARCWriter</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=s>from ha_backend.db import get_session</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=s>from ha_backend.models import Source, Snapshot</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=s>root = Path(&quot;.dev-archive-root&quot;) / &quot;manual-warcs&quot;</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=s>warc_path = root / &quot;viewer-test.warc.gz&quot;</span>
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=s>url = &quot;https://example.org/page&quot;</span>
<a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=s>html_body = &quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello from WARC&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
<a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>
<a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=s>root.mkdir(parents=True, exist_ok=True)</span>
<a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=s>with warc_path.open(&quot;wb&quot;) as f:</span>
<a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=s>    writer = WARCWriter(f, gzip=True)</span>
<a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=s>    payload = BytesIO(</span>
<a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=s>        (</span>
<a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=s>            &quot;HTTP/1.1 200 OK\\r\\n&quot;</span>
<a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=s>            &quot;Content-Type: text/html; charset=utf-8\\r\\n&quot;</span>
<a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=s>            f&quot;Content-Length: {len(html_body.encode(&#39;utf-8&#39;))}\\r\\n&quot;</span>
<a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=s>            &quot;\\r\\n&quot; +</span>
<a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=s>            html_body</span>
<a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=s>        ).encode(&quot;utf-8&quot;)</span>
<a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=s>    )</span>
<a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=s>    record = writer.create_warc_record(</span>
<a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=s>        uri=url,</span>
<a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=s>        record_type=&quot;response&quot;,</span>
<a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=s>        payload=payload,</span>
<a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a><span class=s>        warc_headers_dict={&quot;WARC-Date&quot;: &quot;2025-01-01T12:00:00Z&quot;},</span>
<a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a><span class=s>    )</span>
<a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a><span class=s>    writer.write_record(record)</span>
<a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a><span class=s>    record_id = record.rec_headers.get_header(&quot;WARC-Record-ID&quot;)</span>
<a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a>
<a id=__codelineno-27-37 name=__codelineno-27-37 href=#__codelineno-27-37></a><span class=s>with get_session() as session:</span>
<a id=__codelineno-27-38 name=__codelineno-27-38 href=#__codelineno-27-38></a><span class=s>    src = session.query(Source).filter_by(code=&quot;test&quot;).one_or_none()</span>
<a id=__codelineno-27-39 name=__codelineno-27-39 href=#__codelineno-27-39></a><span class=s>    if src is None:</span>
<a id=__codelineno-27-40 name=__codelineno-27-40 href=#__codelineno-27-40></a><span class=s>        src = Source(</span>
<a id=__codelineno-27-41 name=__codelineno-27-41 href=#__codelineno-27-41></a><span class=s>            code=&quot;test&quot;,</span>
<a id=__codelineno-27-42 name=__codelineno-27-42 href=#__codelineno-27-42></a><span class=s>            name=&quot;Test Source&quot;,</span>
<a id=__codelineno-27-43 name=__codelineno-27-43 href=#__codelineno-27-43></a><span class=s>            base_url=&quot;https://example.org&quot;,</span>
<a id=__codelineno-27-44 name=__codelineno-27-44 href=#__codelineno-27-44></a><span class=s>            description=&quot;Test source for viewer&quot;,</span>
<a id=__codelineno-27-45 name=__codelineno-27-45 href=#__codelineno-27-45></a><span class=s>            enabled=True,</span>
<a id=__codelineno-27-46 name=__codelineno-27-46 href=#__codelineno-27-46></a><span class=s>        )</span>
<a id=__codelineno-27-47 name=__codelineno-27-47 href=#__codelineno-27-47></a><span class=s>        session.add(src)</span>
<a id=__codelineno-27-48 name=__codelineno-27-48 href=#__codelineno-27-48></a><span class=s>        session.flush()</span>
<a id=__codelineno-27-49 name=__codelineno-27-49 href=#__codelineno-27-49></a>
<a id=__codelineno-27-50 name=__codelineno-27-50 href=#__codelineno-27-50></a><span class=s>    snap = Snapshot(</span>
<a id=__codelineno-27-51 name=__codelineno-27-51 href=#__codelineno-27-51></a><span class=s>        job_id=None,</span>
<a id=__codelineno-27-52 name=__codelineno-27-52 href=#__codelineno-27-52></a><span class=s>        source_id=src.id,</span>
<a id=__codelineno-27-53 name=__codelineno-27-53 href=#__codelineno-27-53></a><span class=s>        url=url,</span>
<a id=__codelineno-27-54 name=__codelineno-27-54 href=#__codelineno-27-54></a><span class=s>        normalized_url_group=url,</span>
<a id=__codelineno-27-55 name=__codelineno-27-55 href=#__codelineno-27-55></a><span class=s>        capture_timestamp=datetime(2025, 1, 1, 12, 0, tzinfo=timezone.utc),</span>
<a id=__codelineno-27-56 name=__codelineno-27-56 href=#__codelineno-27-56></a><span class=s>        mime_type=&quot;text/html&quot;,</span>
<a id=__codelineno-27-57 name=__codelineno-27-57 href=#__codelineno-27-57></a><span class=s>        status_code=200,</span>
<a id=__codelineno-27-58 name=__codelineno-27-58 href=#__codelineno-27-58></a><span class=s>        title=&quot;Viewer Test Page&quot;,</span>
<a id=__codelineno-27-59 name=__codelineno-27-59 href=#__codelineno-27-59></a><span class=s>        snippet=&quot;Hello from WARC&quot;,</span>
<a id=__codelineno-27-60 name=__codelineno-27-60 href=#__codelineno-27-60></a><span class=s>        language=&quot;en&quot;,</span>
<a id=__codelineno-27-61 name=__codelineno-27-61 href=#__codelineno-27-61></a><span class=s>        warc_path=str(warc_path),</span>
<a id=__codelineno-27-62 name=__codelineno-27-62 href=#__codelineno-27-62></a><span class=s>        warc_record_id=record_id,</span>
<a id=__codelineno-27-63 name=__codelineno-27-63 href=#__codelineno-27-63></a><span class=s>    )</span>
<a id=__codelineno-27-64 name=__codelineno-27-64 href=#__codelineno-27-64></a><span class=s>    session.add(snap)</span>
<a id=__codelineno-27-65 name=__codelineno-27-65 href=#__codelineno-27-65></a><span class=s>    session.flush()</span>
<a id=__codelineno-27-66 name=__codelineno-27-66 href=#__codelineno-27-66></a><span class=s>    print(&quot;SNAPSHOT_ID&quot;, snap.id)</span>
<a id=__codelineno-27-67 name=__codelineno-27-67 href=#__codelineno-27-67></a><span class=s>PY</span>
</code></pre></div> <p>Note the printed <code>SNAPSHOT_ID</code> (for example <code>5</code>), then:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>curl<span class=w> </span><span class=s2>&quot;http://localhost:8001/api/snapshots/raw/5&quot;</span>
</code></pre></div> <p>You should see the HTML body with <code>"Hello from WARC"</code>, confirming that:</p> <ul> <li><code>warc_path</code> is valid.</li> <li><code>warc_record_id</code> is used for lookup.</li> <li><code>viewer.py</code> can reconstruct and return HTML.</li> </ul> <h3 id=62-error-path-when-warcs-are-missing>6.2 Error path when WARCs are missing</h3> <p>For snapshots whose <code>warc_path</code> points to a non‑existent file (e.g., your seeded dev snapshots), the route returns a meaningful error:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>curl<span class=w> </span><span class=s2>&quot;http://localhost:8001/api/snapshots/raw/1&quot;</span>
</code></pre></div> <p>Returns HTTP 404 with <code>{"detail":"Underlying WARC file for this snapshot is missing"}</code>.</p> <hr> <h2 id=7-real-warc-indexing-advanced>7. Real WARC indexing (advanced)</h2> <p>Goal: take a small real Zimit crawl, fix any permission issues, and index its WARCs into snapshots for use via the HTTP API.</p> <p>This section assumes you have already run a small crawl with something like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>ha-backend<span class=w> </span>run-job<span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=w>  </span>--name<span class=w> </span>hc-dev-warcs<span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=w>  </span>--seeds<span class=w> </span>https://www.canada.ca/en/health-canada.html<span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=w>  </span>--initial-workers<span class=w> </span><span class=m>1</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=w>  </span>--log-level<span class=w> </span>INFO<span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>  </span>--<span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>  </span>--pageLimit<span class=w> </span><span class=m>5</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>  </span>--depth<span class=w> </span><span class=m>1</span>
</code></pre></div> <p>and have a job directory such as:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>.dev-archive-root/20251210T013134Z__hc-dev-warcs
</code></pre></div> <h3 id=71-fix-permissions-on-the-temp-dir-if-needed>7.1 Fix permissions on the temp dir (if needed)</h3> <p>Zimit may create <code>.tmp*</code> directories owned by <code>root</code>, which prevents the backend from reading WARCs. In the job directory:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=nb>cd</span><span class=w> </span>.dev-archive-root/20251210T013134Z__hc-dev-warcs
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>ls<span class=w> </span>-ld<span class=w> </span>.tmp*
</code></pre></div> <p>If you see <code>drwx------ root root ...</code>, fix ownership:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>sudo<span class=w> </span>chown<span class=w> </span>-R<span class=w> </span><span class=k>$(</span>id<span class=w> </span>-u<span class=k>)</span>:<span class=k>$(</span>id<span class=w> </span>-g<span class=k>)</span><span class=w> </span>.tmp*
</code></pre></div> <p>Verify you can see WARCs:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>find<span class=w> </span>.<span class=w> </span>-maxdepth<span class=w> </span><span class=m>6</span><span class=w> </span>-type<span class=w> </span>f<span class=w> </span><span class=se>\(</span><span class=w> </span>-name<span class=w> </span><span class=s1>&#39;*.warc&#39;</span><span class=w> </span>-o<span class=w> </span>-name<span class=w> </span><span class=s1>&#39;*.warc.gz&#39;</span><span class=w> </span><span class=se>\)</span><span class=w> </span>-print
</code></pre></div> <p>You should see something like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>./.tmpXXXX/collections/crawl-.../archive/rec-...warc.gz
</code></pre></div> <h3 id=72-create-a-db-job-pointing-at-this-output_dir>7.2 Create a DB job pointing at this output_dir</h3> <p>From the repo root:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>python<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt; &#39;PY&#39;</span>
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=s>from datetime import datetime, timezone</span>
<a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=s>from pathlib import Path</span>
<a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>
<a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=s>from ha_backend.db import get_session</span>
<a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=s>from ha_backend.models import ArchiveJob, Source</span>
<a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a>
<a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=s>job_dir = Path(&quot;.dev-archive-root/20251210T013134Z__hc-dev-warcs&quot;).resolve()</span>
<a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a>
<a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=s>with get_session() as session:</span>
<a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=s>    src = session.query(Source).filter_by(code=&quot;hc&quot;).one()</span>
<a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=s>    now = datetime.now(timezone.utc)</span>
<a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=s>    job = ArchiveJob(</span>
<a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=s>        source_id=src.id,</span>
<a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=s>        name=&quot;hc-dev-warcs&quot;,</span>
<a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=s>        output_dir=str(job_dir),</span>
<a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=s>        status=&quot;completed&quot;,   # ready for indexing</span>
<a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=s>        queued_at=now,</span>
<a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=s>        started_at=now,</span>
<a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=s>        finished_at=now,</span>
<a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=s>    )</span>
<a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=s>    session.add(job)</span>
<a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=s>    session.flush()</span>
<a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=s>    print(&quot;JOB_ID&quot;, job.id)</span>
<a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=s>PY</span>
</code></pre></div> <p>Note the printed <code>JOB_ID</code> (e.g. <code>11</code>).</p> <p><strong>Alternative (CLI):</strong> you can now do the same with a helper command:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>ha-backend<span class=w> </span>register-job-dir<span class=w> </span><span class=se>\</span>
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=w>  </span>--source<span class=w> </span>hc<span class=w> </span><span class=se>\</span>
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=w>  </span>--output-dir<span class=w> </span>.dev-archive-root/20251210T013134Z__hc-dev-warcs<span class=w> </span><span class=se>\</span>
<a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=w>  </span>--name<span class=w> </span>hc-dev-warcs
</code></pre></div> <p>This creates a DB row in <code>status="completed"</code> so it is ready for indexing.</p> <h3 id=73-index-the-job-and-verify-via-api>7.3 Index the job and verify via API</h3> <p>Index the WARCs:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a>ha-backend<span class=w> </span>index-job<span class=w> </span>--id<span class=w> </span>JOB_ID
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a>ha-backend<span class=w> </span>show-job<span class=w> </span>--id<span class=w> </span>JOB_ID
</code></pre></div> <p>You should see:</p> <ul> <li><code>status="indexed"</code></li> <li><code>warc_file_count &gt; 0</code></li> <li><code>indexed_page_count &gt; 0</code></li> </ul> <p>With uvicorn running:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>curl<span class=w> </span>http://localhost:8001/api/sources
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>curl<span class=w> </span><span class=s2>&quot;http://localhost:8001/api/search?q=health&amp;source=hc&quot;</span>
</code></pre></div> <p>You will see the real crawl snapshots alongside any synthetic dev data.</p> <hr> <h2 id=8-admin-retry-and-cleanup-flows>8. Admin, retry, and cleanup flows</h2> <p>Goal: exercise non‑happy‑path and maintenance commands.</p> <h3 id=81-retry-jobs>8.1 Retry jobs</h3> <p>If a job has <code>status="failed"</code> or <code>status="index_failed"</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>ha-backend<span class=w> </span>retry-job<span class=w> </span>--id<span class=w> </span>JOB_ID
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>ha-backend<span class=w> </span>show-job<span class=w> </span>--id<span class=w> </span>JOB_ID
</code></pre></div> <p>Behavior:</p> <ul> <li><code>status="failed"</code> → <code>status="retryable"</code> (for another crawl).</li> <li><code>status="index_failed"</code> → <code>status="completed"</code> (allowing re‑indexing).</li> </ul> <h3 id=82-cleanup-temp-dirs-and-state>8.2 Cleanup temp dirs and state</h3> <p>Only allowed for <code>status in {"indexed", "index_failed"}</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>ha-backend<span class=w> </span>cleanup-job<span class=w> </span>--id<span class=w> </span>JOB_ID<span class=w> </span>--mode<span class=w> </span>temp
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>ha-backend<span class=w> </span>show-job<span class=w> </span>--id<span class=w> </span>JOB_ID
</code></pre></div> <p>This:</p> <ul> <li>Locates temp dirs and <code>.archive_state.json</code> via <code>archive_tool.state</code>.</li> <li>Deletes <code>.tmp*</code> dirs and the state file.</li> <li>Sets:</li> <li><code>cleanup_status = "temp_cleaned"</code></li> <li><code>cleaned_at</code> to the cleanup time</li> <li><code>state_file_path = None</code></li> </ul> <blockquote> <p><strong>Caution:</strong> This removes temp crawl artifacts (including WARCs) under <code>.tmp*</code> for that job. Only run it once you are satisfied with indexing and any ZIMs/exports.</p> <p>If you are using the replay service (pywb) to serve this job’s WARCs, do not run <code>cleanup-job --mode temp</code> for that job — replay depends on the WARCs remaining on disk.</p> <p>If replay is enabled globally (<code>HEALTHARCHIVE_REPLAY_BASE_URL</code> is set), <code>cleanup-job --mode temp</code> will refuse unless you pass <code>--force</code>. Treat <code>--force</code> as an emergency override (it can break replay by deleting WARCs).</p> </blockquote> <hr> <h2 id=9-metrics-and-observability>9. Metrics and observability</h2> <p>Goal: validate Prometheus‑style metrics.</p> <p>With uvicorn running:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>curl<span class=w> </span>-H<span class=w> </span><span class=s2>&quot;Authorization: Bearer localdev-admin&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=w>  </span>http://localhost:8001/metrics<span class=w> </span><span class=p>|</span><span class=w> </span>head
</code></pre></div> <p>Look for:</p> <ul> <li>Job status metrics:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>healtharchive_jobs_total{status=&quot;failed&quot;} 6
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>healtharchive_jobs_total{status=&quot;indexed&quot;} 1
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a>...
</code></pre></div> <ul> <li>Cleanup status metrics:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>healtharchive_jobs_cleanup_status_total{cleanup_status=&quot;none&quot;} ...
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>healtharchive_jobs_cleanup_status_total{cleanup_status=&quot;temp_cleaned&quot;} ...
</code></pre></div> <ul> <li>Snapshot metrics:</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>healtharchive_snapshots_total 5
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>healtharchive_snapshots_total{source=&quot;hc&quot;} 3
<a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>healtharchive_snapshots_total{source=&quot;test&quot;} 2
</code></pre></div> <ul> <li>Page-level crawl metrics (best-effort from crawl logs):</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>healtharchive_jobs_pages_crawled_total 1234
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>healtharchive_jobs_pages_crawled_total{source=&quot;hc&quot;} 789
<a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>healtharchive_jobs_pages_failed_total 12
<a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a>healtharchive_jobs_pages_failed_total{source=&quot;hc&quot;} 3
</code></pre></div> <p>Counts should roughly match <code>ha-backend list-jobs</code>, <code>/api/sources</code> / <code>/api/search</code>, and the page counters shown in <code>/api/admin/jobs/{id}</code>.</p> <hr> <h2 id=10-scaling-up-to-more-realistic-scenarios>10. Scaling up to more realistic scenarios</h2> <p>Once the above is stable, you can incrementally increase realism:</p> <ul> <li><strong>Multiple jobs with the worker running continuously.</strong></li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a>ha-backend<span class=w> </span>start-worker<span class=w> </span>--poll-interval<span class=w> </span><span class=m>30</span>
</code></pre></div> <p>In another terminal, periodically run <code>create-job</code> and watch statuses transition through <code>queued → running → completed → indexed/index_failed</code>.</p> <ul> <li> <p><strong>Postgres instead of SQLite</strong> by pointing <code>HEALTHARCHIVE_DATABASE_URL</code> at a dev Postgres instance and re‑running <code>alembic upgrade head</code>.</p> </li> <li> <p><strong>Monitoring/adaptive options</strong> via <code>job_registry</code> overrides:</p> </li> <li> <p>Enable <code>enable_monitoring</code>, <code>enable_adaptive_workers</code>, <code>enable_vpn_rotation</code> and confirm they affect archive_tool behavior.</p> </li> <li> <p><strong>Frontend integration</strong> by running the separate <code>healtharchive-frontend</code> against your local backend (<code>NEXT_PUBLIC_BACKEND_URL=http://localhost:8001</code>) and exercising the full UI → API → DB → WARC stack.</p> </li> </ul> <blockquote> <p><strong>Note on real WARCs:</strong> At time of writing, the default Zimit image may not leave WARCs in the expected <code>/output/.tmp*/collections/.../archive</code> path or may create temp directories with restrictive permissions. For backend/API and viewer development, using synthetic WARCs (as in 6.1) and seeded snapshots is sufficient. Integrating with live WARCs may require either adjusting Zimit options or updating WARC discovery to match the crawler’s current layout and permissions.</p> </blockquote> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jerdaw/healtharchive-backend target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://twitter.com/healtharchive target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "navigation.expand", "navigation.indexes", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>